name: Release to GitHub
on:
  workflow_call:
    inputs:
      version:
        description: 'The new version to tag, ex: 0.9.102'
        required: true
        type: string
    secrets:
      OPEN_CAPTURE_SDK_PRS_APP_ID:
        required: true
      OPEN_CAPTURE_SDK_PRS_PRIVATE_KEY:
        required: true
  workflow_dispatch:
    inputs:
      version:
        description: 'The new version to tag, ex: 0.9.102'
        required: true
        type: string    
jobs:
  verify-version:
    name: Verify arguments
    runs-on: ubuntu-latest
    steps:
      - name: Print & verify entered "version"
        run: |
          echo "$VERSION"
          if [[ ! "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[a-z]+(\.[0-9]+)?)?$ ]]; then exit 1; fi
    env:
      VERSION: ${{ inputs.version }}
  # The iOS release build builds the xcframework in release mode and uploads it to the artifact store for later use.
  ios-release-build:
    name: Capture.xcframework with artifacts
    needs: ["verify-version"]
    runs-on: macos-15
    steps:
      - uses: actions/checkout@v4
      - name: 'Update the content of platform/shared/.sdk_version'
        run: echo -n "${{ inputs.version }}" > platform/shared/.sdk_version
      - name: 'Install dependencies'
        run: ./ci/mac_ci_setup.sh
      - name: Build xcframework + artifacts
        run: |
          ./tools/ios_release.sh Capture "${{ inputs.version }}"
          mv ./dist/Capture.ios.zip ./Capture.ios.zip
          mv ./dist/Capture.doccarchive.ios.zip ./Capture.doccarchive.ios.zip
      - uses: actions/upload-artifact@v4
        with:
          name: Capture.ios.zip
          path: ./Capture.ios.zip
      - uses: actions/upload-artifact@v4
        with:
          name: Capture.doccarchive.ios.zip
          path: ./Capture.doccarchive.ios.zip
  build-ios-example-apps:
    needs: ["verify-version"]
    permissions:
      contents: write
    uses: ./.github/workflows/example_apps_ios.yaml
    secrets: inherit

  # The Android release build builds capture.aar and accompanying artifacts, like the .pom xml and the symbols corresponding to the .so.
  android-release-build:
    name: Capture.aar with artifacts
    needs: ["verify-version"]
    runs-on: ubuntu-latest
    steps:
      # Checkout repo to Github Actions runner
      - uses: actions/checkout@v4
      - name: 'Update the content of platform/shared/.sdk_version'
        run: echo -n "${{ inputs.version }}" > platform/shared/.sdk_version
      - name: Install Clang
        run: sudo apt-get install -y clang
      - name: Build AAR + artifacts
        run: ./tools/android_release.sh "$VERSION"
        env:
          VERSION: ${{ inputs.version }}
      - uses: actions/upload-artifact@v4
        with:
          name: Capture.android.zip
          path: ./dist/Capture.android.zip
  build-android-example-apps:
    needs: ["verify-version"]
    permissions:
      contents: write
    uses: ./.github/workflows/example_apps_android.yaml
    secrets: inherit
  build-android-integrations:
    name: Build Android Integrations
    needs: ["verify-version"]
    permissions:
      contents: write
    uses: ./.github/workflows/integrations_android.yaml
    with:
      version: ${{ inputs.version }}
    secrets: inherit

  create-release:
    permissions:
      contents: write
    name: GitHub release
    runs-on: ubuntu-latest
    needs: [
      "ios-release-build",
      "build-ios-example-apps",
      "android-release-build",
      "build-android-example-apps",
      "build-android-integrations",
    ]
    steps:
      - uses: actions/checkout@v4
      # Download all artifacts to current working directory
      - name: Download All artifacts
        uses: actions/download-artifact@v4
        with:
          merge-multiple: true
      - name: Prepare Android artifacts
        run: ./ci/gh_prepare_android_artifacts.sh "$VERSION"
        env:
          VERSION: ${{ inputs.version }}
      - name: Prepare iOS artifacts
        run: |
          mv Capture.ios.zip Capture-$VERSION.ios.zip
          mv Capture.doccarchive.ios.zip Capture-$VERSION.doccarchive.ios.zip
        env:
          VERSION: ${{ inputs.version }}
      - name: 'Create Github Token'
        if: ${{ github.ref_name == 'main' }}
        id: org-pr-create-token
        uses: getsentry/action-github-app-token@d4b5da6c5e37703f8c3b3e43abb5705b46e159cc # v3.0.0
        with:
          app_id: ${{ secrets.OPEN_CAPTURE_SDK_PRS_APP_ID }}
          private_key: ${{ secrets.OPEN_CAPTURE_SDK_PRS_PRIVATE_KEY }}

      - name: 'Commit & push to main only'
        if: ${{ github.ref_name == 'main' }}
        env:
          GH_TOKEN: ${{ steps.org-pr-create-token.outputs.token }}
          VERSION: ${{ inputs.version }}
        run: |
          content=$(echo -n "$VERSION" | base64)
          sha=$(gh api \
            repos/${GITHUB_REPOSITORY}/contents/platform/shared/.sdk_version \
            -q .sha || true)

          gh api \
            --method PUT \
            repos/${GITHUB_REPOSITORY}/contents/platform/shared/.sdk_version \
            -f message="Update SDK version to ${VERSION}" \
            -f content="${content}" \
            -f sha="${sha}" \
            -f branch="main"

        # Use CHANGELOG.md in root
        # Extracts the content between the second and third H2 header (the latest released version)
      - name: Extract release notes
        id: extract-release-notes
        uses: ffurrer2/extract-release-notes@v2

        # Upload artifacts to the newly created release.
        # Prefix release version with "v".
      - name: Create release
        run: |
          ls -R
          RELEASE_NOTES='${{ steps.extract-release-notes.outputs.release_notes }}'
          ARTIFACTS=(
            "Capture-$VERSION.ios.zip"
            "Capture-$VERSION.doccarchive.ios.zip"
            "Capture-$VERSION.android.zip"
            "example-apps.ios.zip"
            "example-apps.android.zip"
            "capture-timber-$VERSION.android.zip"
            "capture-apollo-$VERSION.android.zip"
            "capture-plugin-$VERSION.android.zip"
            "capture-plugin-marker-$VERSION.android.zip"
          )
          
          if [ -z "$RELEASE_NOTES" ] || [ "$RELEASE_NOTES" = "null" ]; then
            echo "Release notes are empty, using --generate-notes"
            gh release create "v$VERSION" \
              --target "$GITHUB_REF_NAME" \
              --generate-notes \
              "${ARTIFACTS[@]}"
          else
            echo "$RELEASE_NOTES" | grep -v "^\[$VERSION\]:" > /tmp/release_notes.md
            echo "Using release notes from CHANGELOG.md"
            head -5 /tmp/release_notes.md
            echo "---"
            gh release create "v$VERSION" \
              --target "$GITHUB_REF_NAME" \
              --notes-file /tmp/release_notes.md \
              "${ARTIFACTS[@]}"
          fi
        env:
          VERSION: ${{ inputs.version }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
