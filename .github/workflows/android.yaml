name: android
on:
  push:
    branches:
      - main
  pull_request:

# Cancel in-progress CI jobs when a new commit is pushed to a PR.
concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.run_id }}
  cancel-in-progress: true

permissions:
  actions: write
  contents: write
  pull-requests: write
  statuses: write

jobs:
  pre_check:
    name: pre_check
    runs-on: ubuntu-latest
    outputs:
      should_run: ${{ steps.check_changes.outputs.run_tests }}
    steps:
      # Checkout repo to Github Actions runner
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # Check for Bazel build file changes
      - name: Check for Bazel build file changes
        id: bazel_check
        run: ./ci/check_bazel.sh //examples/android:android_app
        continue-on-error: true

      - name: Check for workflow file changes
        id: workflow_check
        run: ./ci/files_changed.sh .github/workflows/android.yaml
        continue-on-error: true

      - name: Check for relevant Gradle changes
        id: gradle_check
        run: ./ci/files_changed.sh "^platform/jvm/gradle-test-app/.*\.(gradle|kts|kt|xml)$" && ./ci/files_changed.sh "^platform/jvm/capture/src/test/.*$"
        continue-on-error: true

      - name: Check for Cargo.toml changes
        id: cargo_check
        run: ./ci/files_changed.sh Cargo.toml
        continue-on-error: true

      - name: Determine if tests should run
        id: check_changes_separate
        run: |
          bazel_status="${{ steps.bazel_check.outputs.check_result }}"
          workflow_status="${{ steps.workflow_check.outputs.check_result }}"
          gradle_status="${{ steps.gradle_check.outputs.check_result }}"
          cargo_status="${{ steps.cargo_check.outputs.check_result }}"

          # Check if any status indicates a relevant change or error
          if [[ "$bazel_status" == "1" || "$workflow_status" == "1" || "$gradle_status" == "1" || "$cargo_status" == "1" ]]; then
            echo "An unexpected issue occurred during checks."
            exit 1
          elif [[ "$bazel_status" == "0" || "$workflow_status" == "0" || "$gradle_status" == "0" || "$cargo_status" == "0" ]]; then
            echo "Changes detected in one or more checks. Running tests."
            echo "run_tests=true" >> $GITHUB_ENV
          elif [[ "$bazel_status" == "2" && "$workflow_status" == "2" && "$gradle_status" == "2" && "$cargo_status" == "2" ]]; then
            echo "No relevant changes found."
            echo "run_tests=false" >> $GITHUB_ENV
          else
            echo "Unknown issue."
            exit 1
          fi
        shell: bash

      - name: Run downstream tests if changes are detected
        id: check_changes
        if: env.run_tests == 'true'
        run: ./ci/run_tests.sh

  build_and_compare_apk:
    runs-on: ubuntu-latest
    if: needs.pre_check.outputs.should_run == 'true'
    needs: pre_check
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Build Bazel APK 
        timeout-minutes: 30
        run: ./bazelw build --config ci --config release-android --android_platforms=@rules_android//:x86_64 //examples/android:android_app

      - name: Upload PR APK
        uses: actions/upload-artifact@v4
        with:
          name: android_app.apk
          path: ./bazel-bin/examples/android/android_app.apk

      - name: Save APK size baseline and push to branch (main only)
        if: github.ref == 'refs/heads/main' && success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          APK_PATH=$(find bazel-bin/examples/android -name "android_app.apk" | head -n 1)
          SIZE_FILE=ci/baseline_binary_size.txt
          stat -c%s "$APK_PATH" > "$SIZE_FILE"

          git config user.name "github-actions"
          git config user.email "github-actions@users.noreply.github.com"
          git remote set-url origin https://x-access-token:${GITHUB_TOKEN}@github.com/${GITHUB_REPOSITORY}.git
          git fetch origin binary-size-baseline
          git worktree add temp-worktree origin/binary-size-baseline

          cp "$SIZE_FILE" temp-worktree/ci/

          cd temp-worktree
          git add ci/baseline_binary_size.txt

          if ! git diff --cached --quiet; then
            git commit -m "ci: update Bazel APK size baseline [skip ci]"
            git push origin HEAD:binary-size-baseline
          else
            echo "No changes to baseline size."
          fi

          cd ..
          git worktree remove temp-worktree --force

      - name: Fetch APK size baseline from branch (PR only)
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
        run: |
          git fetch origin binary-size-baseline
          git worktree add temp-baseline origin/binary-size-baseline
          cp temp-baseline/ci/baseline_binary_size.txt ci/
          git worktree remove temp-baseline --force

      - name: Compute and compare APK size
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
        id: apk_size
        run: |
          APK_PATH=$(find bazel-bin/examples/android -name "android_app.apk" | head -n 1)
          BASELINE_PATH=ci/baseline_binary_size.txt

          if [ -z "$APK_PATH" ]; then
            echo "‚ùå Current APK file not found!"
            exit 1
          fi

          CURRENT_SIZE=$(stat -c%s "$APK_PATH")
          CURRENT_KB=$((CURRENT_SIZE / 1024))
          echo "current_kb=$CURRENT_KB" >> $GITHUB_OUTPUT

          if [ ! -f "$BASELINE_PATH" ]; then
            echo "baseline_kb=" >> $GITHUB_OUTPUT
            echo "diff_kb=" >> $GITHUB_OUTPUT
          else
            BASELINE_SIZE=$(cat "$BASELINE_PATH")
            BASELINE_KB=$((BASELINE_SIZE / 1024))
            DIFF_KB=$((CURRENT_KB - BASELINE_KB))
            echo "baseline_kb=$BASELINE_KB" >> $GITHUB_OUTPUT
            echo "diff_kb=$DIFF_KB" >> $GITHUB_OUTPUT
          fi

      - name: Report APK size on PR
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.full_name == github.repository
        uses: actions/github-script@v6
        env:
          CURRENT_KB: ${{ steps.apk_size.outputs.current_kb }}
          BASELINE_KB: ${{ steps.apk_size.outputs.baseline_kb }}
          DIFF_KB: ${{ steps.apk_size.outputs.diff_kb }}
        with:
          script: |
            const current = process.env.CURRENT_KB;
            const baseline = process.env.BASELINE_KB;
            const diff = process.env.DIFF_KB;

            let body = '';

            if (baseline && baseline !== '') {
              body = `
              ### üì¶ Bazel APK(x86_64) Size Report

              | Metric     | Size (KB) |
              |------------|-----------|
              | Baseline   | ${baseline} |
              | Current    | ${current} |
              | Difference | ${diff} |

              `;

              if (parseInt(diff, 10) > 0) {
                body += `> ‚ùå Bazel APK(x86_64) size increased by ${diff} KB.`;
              } else if (parseInt(diff, 10) < 0) {
                body += `> ‚úÖ Bazel APK(x86_64) size decreased by ${Math.abs(diff)} KB.`;
              } else {
                body += `> ‚úÖ Bazel APK(x86_64) size unchanged.`;
              }
            } else {
              body = `üìå Current Bazel APK(x86_64) size: ${current} KB (No baseline available for comparison).`;
            }

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.pull_request.number,
              body: body
            });

  gradle_tests:
    # Requires a "larger runner", for nested virtualization support
    runs-on: ubuntu-latest-8-cores
    env:
      SKIP_PROTO_GEN: 1
    if: needs.pre_check.outputs.should_run == 'true'
    needs: pre_check
    steps:

    - name: Checkout project sources
      uses: actions/checkout@v4

    - name: Setup Android cmd line tools + NDK
      uses: ./.github/actions/common-android-setup

    - name: Accept Android SDK licenses
      run: yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses

    - name: Set up Rust ARM target
      run: rustup update && rustup target add aarch64-linux-android && rustup target add x86_64-linux-android

    - name: Cache cargo-ndk
      id: cargo-ndk-cache
      uses: actions/cache@v4
      with:
        path: ~/.cargo/bin/cargo-ndk
        key: ${{ runner.os }}-cargo-ndk-3.4
    - name: Install cargo-ndk
      if: steps.cargo-ndk-cache.outputs.cache-hit != 'true'
      run: cargo install cargo-ndk --version 3.4.0 --locked
    # See https://github.blog/changelog/2023-02-23-hardware-accelerated-android-virtualization-on-actions-windows-and-linux-larger-hosted-runners/
    - name: Enable KVM group perms
      run: |
        echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
        sudo udevadm control --reload-rules
        sudo udevadm trigger --name-match=kvm
    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        distribution: 'zulu'
        java-version: '17'
        cache: gradle
    - name: AVD cache
      uses: actions/cache@v4
      id: avd-cache
      with:
        path: |
          ~/.android/avd/*
          ~/.android/adb*
        key: ${{ runner.os }}-avd-api-24-2
    - name: Create AVD and generate snapshot for caching
      if: steps.avd-cache.outputs.cache-hit != 'true'
      timeout-minutes: 30
      uses: reactivecircus/android-emulator-runner@62dbb605bba737720e10b196cb4220d374026a6d # pin@v2.33
      with:
        channel: stable
        force-avd-creation: false
        api-level: 24
        target: default
        ram-size: 2048M
        arch: x86_64
        disk-size: 6144M
        profile: Nexus 6
        disable-animations: true
        emulator-options: -no-window -accel on -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
        script: echo "Generated AVD snapshot for caching."
    - name: Gradle capture-timber unit tests
      working-directory: ./platform/jvm
      run: ./gradlew capture-timber:testReleaseUnitTest --info
    - name: Check Licenses for modules
      working-directory: ./platform/jvm
      run: ./gradlew replay:checkLicense common:checkLicense capture:checkLicense
    - name: Set up local.properties, required for cargo-ndk
      working-directory: ./platform/jvm
      run: touch local.properties
    - name: Build Microbenchmark target
      working-directory: ./platform/jvm
      run: ./gradlew microbenchmark:assembleAndroidTest
    - name: Instrumentation Tests
      uses: reactivecircus/android-emulator-runner@62dbb605bba737720e10b196cb4220d374026a6d # pin@v2.33
      with:
        channel: stable
        force-avd-creation: false
        api-level: 24
        target: default
        ram-size: 2048M
        arch: x86_64
        disk-size: 6144M
        profile: Nexus 6
        disable-animations: true
        emulator-options: -no-snapshot-save -no-window -accel on -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
        script: cd platform/jvm && adb uninstall io.bitdrift.gradletestapp.test; adb uninstall io.bitdrift.gradletestapp; cd ../.. && ./tools/android_sdk_wrapper.sh platform/jvm/gradlew -Prust-target=x86_64 -p platform/jvm gradle-test-app:check gradle-test-app:connectedCheck --stacktrace

  verify_android_hello_world_per_version:
    needs: build_and_compare_apk
    runs-on: ubuntu-latest-8-cores
    strategy:
      matrix:
        api-level: [24, 35]
    steps:
      # Checkout repo to Github Actions runner
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # See https://github.blog/changelog/2023-02-23-hardware-accelerated-android-virtualization-on-actions-windows-and-linux-larger-hosted-runners/
      - name: Enable KVM group perms
        run: |
            echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
            sudo udevadm control --reload-rules
            sudo udevadm trigger --name-match=kvm
      - uses: actions/download-artifact@v4
        with:
          name: android_app.apk
          path: .
      - name: AVD cache
        uses: actions/cache@v3
        id: avd-cache
        with:
          path: |
            ~/.android/avd/*
            ~/.android/adb*
          key: ${{ runner.os }}-avd-api${{ matrix.api-level }}-1
      - name: Create AVD and generate snapshot for caching
        if: steps.avd-cache.outputs.cache-hit != 'true'
        timeout-minutes: 30
        uses: reactivecircus/android-emulator-runner@62dbb605bba737720e10b196cb4220d374026a6d # pin@v2.33
        with:
          channel: stable
          api-level: ${{ matrix.api-level }}
          target: google_apis
          ram-size: 2048M
          arch: x86_64
          disk-size: 6144M
          profile: Nexus 6
          emulator-options: -no-window -accel on -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          script: echo "Generated AVD snapshot for caching."
      - name: run tests
        uses: reactivecircus/android-emulator-runner@62dbb605bba737720e10b196cb4220d374026a6d # pin@v2.33
        timeout-minutes: 15
        with:
          force-avd-creation: false
          channel: stable
          api-level: ${{ matrix.api-level }}
          target: google_apis
          ram-size: 2048M
          arch: x86_64
          disk-size: 6144M
          profile: Nexus 6
          emulator-options: -no-snapshot-save -no-window -accel on -gpu swiftshader_indirect -noaudio -no-boot-anim -camera-back none
          script: ./ci/verify_android.sh


  test_maven_central_upload:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Install GPG
        run: |
          sudo apt-get update
          sudo apt-get install -y gnupg

      - name: Set up GPG signing key
        env:
          GPG_SIGNING_KEY: ${{ secrets.GPG_SIGNING_KEY }}
          GPG_SIGNING_KEY_PASSPHRASE: ${{ secrets.GPG_SIGNING_KEY_PASSPHRASE }}
        run: |
          echo "$GPG_SIGNING_KEY" | gpg --batch --import
          echo "GPG key imported successfully"
          gpg --list-secret-keys --keyid-format LONG

      - name: Download release artifacts
        env:
          GH_TOKEN: ${{ github.token }}
          VERSION: 0.17.28
          RELEASE_TAG: ${{ inputs.maven_release_tag }}
        run: |
          mkdir -p maven-upload/io/bitdrift/capture/$VERSION
          cd maven-upload/io/bitdrift/capture/$VERSION
          
          echo "Downloading artifacts from release $RELEASE_TAG..."
          gh release download $RELEASE_TAG --pattern "capture-$VERSION-javadoc.jar"
          gh release download $RELEASE_TAG --pattern "capture-$VERSION-sources.jar"
          gh release download $RELEASE_TAG --pattern "capture-$VERSION.aar"
          gh release download $RELEASE_TAG --pattern "capture-$VERSION.pom"
          
          ls -la
          echo "All required artifacts downloaded successfully"

      - name: Generate checksums and signatures
        env:
          GPG_SIGNING_KEY_PASSPHRASE: ${{ secrets.GPG_SIGNING_KEY_PASSPHRASE }}
          VERSION: ${{ inputs.maven_version }}
        run: |
          cd maven-upload/io/bitdrift/capture/$VERSION
          
          echo "Generating checksums..."
          md5sum capture-$VERSION.aar | cut -d' ' -f1 > capture-$VERSION.aar.md5
          sha1sum capture-$VERSION.aar | cut -d' ' -f1 > capture-$VERSION.aar.sha1
          md5sum capture-$VERSION.pom | cut -d' ' -f1 > capture-$VERSION.pom.md5
          sha1sum capture-$VERSION.pom | cut -d' ' -f1 > capture-$VERSION.pom.sha1
          md5sum capture-$VERSION-sources.jar | cut -d' ' -f1 > capture-$VERSION-sources.jar.md5
          sha1sum capture-$VERSION-sources.jar | cut -d' ' -f1 > capture-$VERSION-sources.jar.sha1
          md5sum capture-$VERSION-javadoc.jar | cut -d' ' -f1 > capture-$VERSION-javadoc.jar.md5
          sha1sum capture-$VERSION-javadoc.jar | cut -d' ' -f1 > capture-$VERSION-javadoc.jar.sha1
          
          echo "Generating GPG signatures..."
          echo "$GPG_SIGNING_KEY_PASSPHRASE" | gpg --batch --yes --passphrase-fd 0 --armor --detach-sign capture-$VERSION.aar
          echo "$GPG_SIGNING_KEY_PASSPHRASE" | gpg --batch --yes --passphrase-fd 0 --armor --detach-sign capture-$VERSION.pom
          echo "$GPG_SIGNING_KEY_PASSPHRASE" | gpg --batch --yes --passphrase-fd 0 --armor --detach-sign capture-$VERSION-sources.jar
          echo "$GPG_SIGNING_KEY_PASSPHRASE" | gpg --batch --yes --passphrase-fd 0 --armor --detach-sign capture-$VERSION-javadoc.jar
          
          echo "Verifying signatures..."
          gpg --verify capture-$VERSION.aar.asc capture-$VERSION.aar
          gpg --verify capture-$VERSION.pom.asc capture-$VERSION.pom
          gpg --verify capture-$VERSION-sources.jar.asc capture-$VERSION-sources.jar
          gpg --verify capture-$VERSION-javadoc.jar.asc capture-$VERSION-javadoc.jar
          
          echo "All checksums and signatures generated successfully"
          ls -la

      - name: Create bundle ZIP
        env:
          VERSION: ${{ inputs.maven_version }}
        run: |
          cd maven-upload
          zip -r ../capture-$VERSION-central-bundle.zip io/
          echo "Bundle created: capture-$VERSION-central-bundle.zip"
          ls -la ../capture-$VERSION-central-bundle.zip

      - name: Upload to Maven Central (if not dry run)
        if: ${{ !inputs.maven_dry_run }}
        env:
          MAVEN_CENTRAL_TOKEN_USERNAME: ${{ secrets.MAVEN_CENTRAL_TOKEN_USERNAME }}
          MAVEN_CENTRAL_TOKEN_PASSWORD: ${{ secrets.MAVEN_CENTRAL_TOKEN_PASSWORD }}
          VERSION: ${{ inputs.maven_version }}
        run: |
          BUNDLE_NAME="bitdrift-capture-sdk-$(echo $VERSION | tr '.' '-')"
          
          echo "Uploading bundle to Maven Central as: $BUNDLE_NAME"
          
          # Upload the bundle
          UPLOAD_RESPONSE=$(curl -s -X POST \
            -u "$MAVEN_CENTRAL_TOKEN_USERNAME:$MAVEN_CENTRAL_TOKEN_PASSWORD" \
            -F "bundle=@capture-$VERSION-central-bundle.zip" \
            -F "name=$BUNDLE_NAME" \
            "https://central.sonatype.com/api/v1/publisher/upload")
          
          echo "Upload response: $UPLOAD_RESPONSE"
          
          # Extract deployment ID from response
          DEPLOYMENT_ID=$(echo "$UPLOAD_RESPONSE" | jq -r '.deploymentId // empty')
          
          if [ -z "$DEPLOYMENT_ID" ]; then
            echo "Failed to get deployment ID from upload response"
            echo "Full response: $UPLOAD_RESPONSE"
            exit 1
          fi
          
          echo "Deployment ID: $DEPLOYMENT_ID"
          
          # Check deployment status
          echo "Checking deployment status..."
          for i in {1..30}; do
            STATUS_RESPONSE=$(curl -s -X GET \
              -u "$MAVEN_CENTRAL_TOKEN_USERNAME:$MAVEN_CENTRAL_TOKEN_PASSWORD" \
              "https://central.sonatype.com/api/v1/publisher/status?id=$DEPLOYMENT_ID")
            
            STATUS=$(echo "$STATUS_RESPONSE" | jq -r '.deploymentState // "UNKNOWN"')
            echo "Deployment status (attempt $i): $STATUS"
            
            case "$STATUS" in
              "PUBLISHED")
                echo "‚úÖ Successfully published to Maven Central!"
                exit 0
                ;;
              "FAILED"|"REJECTED")
                echo "‚ùå Deployment failed or was rejected"
                echo "Response: $STATUS_RESPONSE"
                exit 1
                ;;
              "PENDING"|"VALIDATING"|"VALIDATED")
                echo "‚è≥ Still processing... waiting 30 seconds"
                sleep 30
                ;;
              *)
                echo "Unknown status: $STATUS"
                sleep 30
                ;;
            esac
          done
          
          echo "‚ùå Deployment did not complete within expected time"
          exit 1

      - name: Upload bundle as artifact
        uses: actions/upload-artifact@v4
        with:
          name: maven-central-bundle-${{ inputs.maven_version }}
          path: capture-${{ inputs.maven_version }}-central-bundle.zip
          retention-days: 7

      - name: Test Summary
        run: |
          echo "## Maven Central Upload Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ inputs.maven_version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Tag:** ${{ inputs.maven_release_tag }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Dry Run:** ${{ inputs.maven_dry_run }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ inputs.maven_dry_run }}" = "true" ]; then
            echo "‚úÖ **Dry run test completed successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "- Bundle created and uploaded as artifact" >> $GITHUB_STEP_SUMMARY
            echo "- No actual upload to Maven Central performed" >> $GITHUB_STEP_SUMMARY
            echo "- Download the bundle artifact to inspect the generated files" >> $GITHUB_STEP_SUMMARY
          else
            echo "‚úÖ **Upload test completed successfully!**" >> $GITHUB_STEP_SUMMARY
            echo "- Artifacts uploaded to Maven Central" >> $GITHUB_STEP_SUMMARY
            echo "- Available at: https://central.sonatype.com/artifact/io.bitdrift/capture/${{ inputs.maven_version }}" >> $GITHUB_STEP_SUMMARY
          fi


  # This is a noop job that completes once all the jobs spawned by the previous step completes. By blocking PR merges on this
  # job completing, we are able to gate it on all the previous jobs without explicitly enumerating them.
  verify_android:
    runs-on: ubuntu-latest
    needs: ["pre_check", "test_maven_central_upload", "build_and_compare_apk", "verify_android_hello_world_per_version", "gradle_tests"]
    if: always()
    steps:
    # Checkout repo to Github Actions runner
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 1
    - name: check result
      run: ./ci/check_result.sh ${{ needs.pre_check.result }} && ./ci/check_result.sh ${{ needs.build_and_compare_apk.result }} && ./ci/check_result.sh ${{ needs.verify_android_hello_world_per_version.result }} && ./ci/check_result.sh ${{ needs.gradle_tests.result }}
