name: Common Android SDK/NDK setup
description: Sets up Android SDK cmdline-tools and installs the NDK
inputs:
  ndk-version:
    description: Android NDK version to install
    required: false
    default: "27.2.12479018"

runs:
  using: "composite"
  steps:
    - name: Cache Android NDK
      id: ndk-cache
      uses: actions/cache@v4
      with:
        path: ${{ env.ANDROID_SDK_ROOT }}/ndk/${{ inputs.ndk-version }}
        key: ${{ runner.os }}-android-ndk-${{ inputs.ndk-version }}

    - name: Cache Android cmdline-tools
      id: cmdline-tools-cache
      uses: actions/cache@v4
      with:
        path: ${{ env.ANDROID_SDK_ROOT }}/cmdline-tools/latest
        key: ${{ runner.os }}-android-cmdline-tools-v1

    - name: Verify cmdline-tools
      if: steps.cmdline-tools-cache.outputs.cache-hit != 'true'
      shell: bash
      run: |
        echo "cmdline-tools not found or incomplete. Installing..."
        mkdir -p $ANDROID_SDK_ROOT/cmdline-tools
        cd $ANDROID_SDK_ROOT/cmdline-tools
        curl -sSL https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -o cmdline-tools.zip
        unzip -q cmdline-tools.zip
        mv cmdline-tools latest

    - name: Install Android NDK
      if: steps.ndk-cache.outputs.cache-hit != 'true'
      shell: bash
      run: |
        export PATH=$ANDROID_SDK_ROOT/cmdline-tools/latest/bin:$PATH
        yes | sdkmanager "ndk;${{ inputs.ndk-version }}"