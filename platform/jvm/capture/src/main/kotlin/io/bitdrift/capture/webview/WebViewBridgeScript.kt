// AUTO-GENERATED FILE - DO NOT EDIT
// Generated by: npm run generate
// Source: platform/webview/src/

package io.bitdrift.capture.webview

/**
 * Contains the bundled JavaScript SDK for WebView instrumentation.
 * This script is injected into WebViews to capture performance metrics,
 * network events, and user interactions.
 */
internal object WebViewBridgeScript {
    /**
     * The minified JavaScript bundle to inject into WebViews.
     */
    const val SCRIPT: String = """
(function() {
"use strict";var BitdriftWebView=(()=>{var ae=Object.defineProperty;var de=(t,e,r)=>e in t?ae(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var f=(t,e,r)=>de(t,typeof e!="symbol"?e+"":e,r);function ce(){return window.webkit?.messageHandlers?.BitdriftLogger?"ios":window.BitdriftLogger?"android":"unknown"}function U(t){let e=ce(),r=JSON.stringify(t);switch(e){case"ios":window.webkit?.messageHandlers?.BitdriftLogger?.postMessage(t);break;case"android":window.BitdriftLogger?.log(r);break;case"unknown":typeof console<"u"&&console.debug("[Bitdrift WebView]",t);break}}function O(){window.bitdrift||(window.bitdrift={log:U})}function u(t){window.bitdrift?(console.log("[Bitdrift WebView] Logging message via bridge",t),window.bitdrift.log(t)):U(t)}function l(t){return{v:1,timestamp:Date.now(),...t}}var J=-1,w=t=>{addEventListener("pageshow",(e=>{e.persisted&&(J=e.timeStamp,t(e))}),!0)},p=(t,e,r,n)=>{let i,o;return s=>{e.value>=0&&(s||n)&&(o=e.value-(i??0),(o||i===void 0)&&(i=e.value,e.delta=o,e.rating=((a,c)=>a>c[1]?"poor":a>c[0]?"needs-improvement":"good")(e.value,r),t(e)))}},I=t=>{requestAnimationFrame((()=>requestAnimationFrame((()=>t()))))},A=()=>{let t=performance.getEntriesByType("navigation")[0];if(t&&t.responseStart>0&&t.responseStart<performance.now())return t},y=()=>A()?.activationStart??0,g=(t,e=-1)=>{let r=A(),n="navigate";return J>=0?n="back-forward-cache":r&&(document.prerendering||y()>0?n="prerender":document.wasDiscarded?n="restore":r.type&&(n=r.type.replace(/_/g,"-"))),{name:t,value:e,rating:"good",delta:0,entries:[],id:`v5-${'$'}{Date.now()}-${'$'}{Math.floor(8999999999999*Math.random())+1e12}`,navigationType:n}},S=new WeakMap;function N(t,e){return S.get(t)||S.set(t,new e),S.get(t)}var q=class{constructor(){f(this,"t");f(this,"i",0);f(this,"o",[])}h(e){if(e.hadRecentInput)return;let r=this.o[0],n=this.o.at(-1);this.i&&r&&n&&e.startTime-n.startTime<1e3&&e.startTime-r.startTime<5e3?(this.i+=e.value,this.o.push(e)):(this.i=e.value,this.o=[e]),this.t?.(e)}},T=(t,e,r={})=>{try{if(PerformanceObserver.supportedEntryTypes.includes(t)){let n=new PerformanceObserver((i=>{Promise.resolve().then((()=>{e(i.getEntries())}))}));return n.observe({type:t,buffered:!0,...r}),n}}catch{}},H=t=>{let e=!1;return()=>{e||(t(),e=!0)}},v=-1,j=new Set,W=()=>document.visibilityState!=="hidden"||document.prerendering?1/0:0,R=t=>{if(document.visibilityState==="hidden"){if(t.type==="visibilitychange")for(let e of j)e();isFinite(v)||(v=t.type==="visibilitychange"?t.timeStamp:0,removeEventListener("prerenderingchange",R,!0))}},b=()=>{if(v<0){let t=y();v=(document.prerendering?void 0:globalThis.performance.getEntriesByType("visibility-state").filter((r=>r.name==="hidden"&&r.startTime>t))[0]?.startTime)??W(),addEventListener("visibilitychange",R,!0),addEventListener("prerenderingchange",R,!0),w((()=>{setTimeout((()=>{v=W()}))}))}return{get firstHiddenTime(){return v},onHidden(t){j.add(t)}}},L=t=>{document.prerendering?addEventListener("prerenderingchange",(()=>t()),!0):t()},X=[1800,3e3],x=(t,e={})=>{L((()=>{let r=b(),n,i=g("FCP"),o=T("paint",(s=>{for(let a of s)a.name==="first-contentful-paint"&&(o.disconnect(),a.startTime<r.firstHiddenTime&&(i.value=Math.max(a.startTime-y(),0),i.entries.push(a),n(!0)))}));o&&(n=p(t,i,X,e.reportAllChanges),w((s=>{i=g("FCP"),n=p(t,i,X,e.reportAllChanges),I((()=>{i.value=performance.now()-s.timeStamp,n(!0)}))})))}))},_=[.1,.25],K=(t,e={})=>{let r=b();x(H((()=>{let n,i=g("CLS",0),o=N(e,q),s=c=>{for(let d of c)o.h(d);o.i>i.value&&(i.value=o.i,i.entries=o.o,n())},a=T("layout-shift",s);a&&(n=p(t,i,_,e.reportAllChanges),r.onHidden((()=>{s(a.takeRecords()),n(!0)})),w((()=>{o.i=0,i=g("CLS",0),n=p(t,i,_,e.reportAllChanges),I((()=>n()))})),setTimeout(n))})))},Q=0,C=1/0,M=0,ue=t=>{for(let e of t)e.interactionId&&(C=Math.min(C,e.interactionId),M=Math.max(M,e.interactionId),Q=M?(M-C)/7+1:0)},k,D=()=>k?Q:performance.interactionCount??0,le=()=>{"interactionCount"in performance||k||(k=T("event",ue,{type:"event",buffered:!0,durationThreshold:0}))},V=0,P=class{constructor(){f(this,"u",[]);f(this,"l",new Map);f(this,"m");f(this,"p")}v(){V=D(),this.u.length=0,this.l.clear()}L(){let e=Math.min(this.u.length-1,Math.floor((D()-V)/50));return this.u[e]}h(e){if(this.m?.(e),!e.interactionId&&e.entryType!=="first-input")return;let r=this.u.at(-1),n=this.l.get(e.interactionId);if(n||this.u.length<10||e.duration>r.P){if(n?e.duration>n.P?(n.entries=[e],n.P=e.duration):e.duration===n.P&&e.startTime===n.entries[0].startTime&&n.entries.push(e):(n={id:e.interactionId,entries:[e],P:e.duration},this.l.set(n.id,n),this.u.push(n)),this.u.sort(((i,o)=>o.P-i.P)),this.u.length>10){let i=this.u.splice(10);for(let o of i)this.l.delete(o.id)}this.p?.(n)}}},Y=t=>{let e=globalThis.requestIdleCallback||setTimeout;document.visibilityState==="hidden"?t():(t=H(t),addEventListener("visibilitychange",t,{once:!0,capture:!0}),e((()=>{t(),removeEventListener("visibilitychange",t,{capture:!0})})))},${'$'}=[200,500],Z=(t,e={})=>{if(!globalThis.PerformanceEventTiming||!("interactionId"in PerformanceEventTiming.prototype))return;let r=b();L((()=>{le();let n,i=g("INP"),o=N(e,P),s=c=>{Y((()=>{for(let m of c)o.h(m);let d=o.L();d&&d.P!==i.value&&(i.value=d.P,i.entries=d.entries,n())}))},a=T("event",s,{durationThreshold:e.durationThreshold??40});n=p(t,i,${'$'},e.reportAllChanges),a&&(a.observe({type:"first-input",buffered:!0}),r.onHidden((()=>{s(a.takeRecords()),n(!0)})),w((()=>{o.v(),i=g("INP"),n=p(t,i,${'$'},e.reportAllChanges)})))}))},B=class{constructor(){f(this,"m")}h(e){this.m?.(e)}},z=[2500,4e3],ee=(t,e={})=>{L((()=>{let r=b(),n,i=g("LCP"),o=N(e,B),s=c=>{e.reportAllChanges||(c=c.slice(-1));for(let d of c)o.h(d),d.startTime<r.firstHiddenTime&&(i.value=Math.max(d.startTime-y(),0),i.entries=[d],n())},a=T("largest-contentful-paint",s);if(a){n=p(t,i,z,e.reportAllChanges);let c=H((()=>{s(a.takeRecords()),a.disconnect(),n(!0)})),d=m=>{m.isTrusted&&(Y(c),removeEventListener(m.type,d,{capture:!0}))};for(let m of["keydown","click","visibilitychange"])addEventListener(m,d,{capture:!0});w((m=>{i=g("LCP"),n=p(t,i,z,e.reportAllChanges),I((()=>{i.value=performance.now()-m.timeStamp,n(!0)}))}))}}))},G=[800,1800],E=t=>{document.prerendering?L((()=>E(t))):document.readyState!=="complete"?addEventListener("load",(()=>E(t)),!0):setTimeout(t)},te=(t,e={})=>{let r=g("TTFB"),n=p(t,r,G,e.reportAllChanges);E((()=>{let i=A();i&&(r.value=Math.max(i.responseStart-y(),0),r.entries=[i],n(!0),w((()=>{r=g("TTFB",0),n=p(t,r,G,e.reportAllChanges),n(!0)})))}))};function ne(){let t=e=>{let r=l({type:"webVital",metric:e});u(r)};ee(t),K(t),Z(t),x(t),te(t)}var pe=0;function re(){return`req_${'$'}{Date.now()}_${'$'}{++pe}`}function ie(t){if(typeof performance>"u"||!performance.getEntriesByType)return;let r=performance.getEntriesByType("resource").filter(n=>n.name===t).pop();if(r)return{dnsMs:r.domainLookupEnd-r.domainLookupStart,connectMs:r.connectEnd-r.connectStart,tlsMs:r.secureConnectionStart>0?r.connectEnd-r.secureConnectionStart:void 0,ttfbMs:r.responseStart-r.requestStart,downloadMs:r.responseEnd-r.responseStart,transferSize:r.transferSize}}function ge(){let t=window.fetch;t&&(window.fetch=async function(e,r){let n=re(),i=performance.now(),o,s;e instanceof Request?(o=e.url,s=e.method):(o=e.toString(),s=r?.method??"GET");try{let a=await t.call(window,e,r),c=performance.now(),d=l({type:"networkRequest",requestId:n,method:s.toUpperCase(),url:o,statusCode:a.status,durationMs:Math.round(c-i),success:a.ok,requestType:"fetch",timing:ie(o)});return u(d),a}catch(a){let c=performance.now(),d=l({type:"networkRequest",requestId:n,method:s.toUpperCase(),url:o,statusCode:0,durationMs:Math.round(c-i),success:!1,error:a instanceof Error?a.message:String(a),requestType:"fetch"});throw u(d),a}})}function fe(){let t=XMLHttpRequest.prototype.open,e=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.open=function(r,n,i=!0,o,s){return this._bitdrift={method:r.toUpperCase(),url:n.toString(),requestId:re()},t.call(this,r,n,i,o,s)},XMLHttpRequest.prototype.send=function(r){let n=this,i=n._bitdrift;if(!i)return e.call(this,r);let o=performance.now(),s=()=>{let c=performance.now(),d=l({type:"networkRequest",requestId:i.requestId,method:i.method,url:i.url,statusCode:n.status,durationMs:Math.round(c-o),success:n.status>=200&&n.status<400,requestType:"xhr",timing:ie(i.url)});u(d)},a=()=>{let c=performance.now(),d=l({type:"networkRequest",requestId:i.requestId,method:i.method,url:i.url,statusCode:0,durationMs:Math.round(c-o),success:!1,error:"Network error",requestType:"xhr"});u(d)};return n.addEventListener("load",s),n.addEventListener("error",a),n.addEventListener("abort",a),n.addEventListener("timeout",a),e.call(this,r)}}function oe(){ge(),fe()}var h="";function se(){h=window.location.href;let t=history.pushState;history.pushState=function(r,n,i){let o=h;t.call(this,r,n,i);let s=window.location.href;o!==s&&(h=s,F(o,s,"pushState"))};let e=history.replaceState;history.replaceState=function(r,n,i){let o=h;e.call(this,r,n,i);let s=window.location.href;o!==s&&(h=s,F(o,s,"replaceState"))},window.addEventListener("popstate",()=>{let r=h,n=window.location.href;r!==n&&(h=n,F(r,n,"popstate"))})}function F(t,e,r){let n=l({type:"navigation",fromUrl:t,toUrl:e,method:r});u(n)}function me(){O();let t=l({type:"bridgeReady",url:window.location.href});u(t),oe(),se(),ne()}me();})();
})();

"""
}
