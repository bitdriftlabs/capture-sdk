// capture-sdk - bitdrift's client SDK
// Copyright Bitdrift, Inc. All rights reserved.
//
// Use of this source code is governed by a source available license that can be found in the
// LICENSE file or at:
// https://polyformproject.org/wp-content/uploads/2020/06/PolyForm-Shield-1.0.0.txt

// AUTO-GENERATED FILE - DO NOT EDIT
// Generated by: npm run generate
// Source: platform/webview/src/

@file:Suppress("MaxLineLength")

package io.bitdrift.capture.webview

/**
 * Contains the bundled JavaScript SDK for WebView instrumentation.
 * This script is injected into WebViews to capture performance metrics,
 * network events, and user interactions.
 */
internal object WebViewBridgeScript {
    private const val SCRIPT_PREFIX: String = """
(function() {
"use strict";var BitdriftWebView=(()=>{var Fe=Object.defineProperty;var He=(t,e,n)=>e in t?Fe(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var y=(t,e,n)=>He(t,typeof e!="symbol"?e+"":e,n);var s=t=>{try{return t()}catch{return}};var g=t=>(...e)=>{try{return t(...e)}catch{return}};var N={console:{log:console.log,warn:console.warn,error:console.error,info:console.info,debug:console.debug}},Ve=t=>({_source:"webview",_timestamp:(t??Date.now()).toString()}),re=(t,e="")=>{let n={};for(let[r,i]of Object.entries(t)){if(i==null)continue;let o=r.replace(/[A-Z]/g,u=>`_${'$'}{u.toLowerCase()}`),a=e&&o.startsWith("_")?o.substring(1):o,c=e?`${'$'}{e}.${'$'}{a}`:`_${'$'}{o}`;typeof i=="object"&&!Array.isArray(i)?Object.assign(n,re(i,c)):n[c]=i.toString()}return n},We=()=>s(()=>window.webkit?.messageHandlers?.BitdriftLogger?"ios":window.BitdriftLogger?"android":"unknown")??"unknown",ie=t=>{s(()=>{let e=We(),n=JSON.stringify(t);switch(e){case"ios":window.webkit?.messageHandlers?.BitdriftLogger?.postMessage(t);break;case"android":window.BitdriftLogger?.log(n);break;case"unknown":typeof console<"u"&&console.debug("[Bitdrift WebView]",t);break}})},oe=()=>{window.bitdrift?.log||(window.bitdrift={config:window.bitdrift?.config,log:(...t)=>{if(t.length!==1&&t.length!==3)throw new Error("Invalid arguments to bitdrift.log. Expected 1 or 3 arguments.");let e;if(t.length===1)e=t[0];else{let[n,r,i]=t;e=l({type:"customLog",level:n,message:r,fields:i})}ie(e)}})},d=t=>{window.bitdrift?window.bitdrift.log?.(t):ie(t)},Xe=(t,e)=>{let n={};switch(t){case"navigation":n._from_url=String(e.fromUrl??""),n._to_url=String(e.toUrl??""),n._method=String(e.method??"");break;case"error":n._name=String(e.name??"Error"),n._message=String(e.message??"Unknown error"),e.stack&&(n._stack=String(e.stack)),e.filename&&(n._filename=String(e.filename)),e.lineno&&(n._lineno=String(e.lineno)),e.colno&&(n._colno=String(e.colno));break;case"promiseRejection":n._reason=String(e.reason??"Unknown rejection"),e.stack&&(n._stack=String(e.stack));break;case"longTask":n._duration_ms=String(e.durationMs??0),n._start_time=String(e.startTime??0),e.attribution&&typeof e.attribution=="object"&&Object.assign(n,re(e.attribution,"_attribution"));break;case"pageView":n._span_id=String(e.spanId??""),n._url=String(e.url??""),n._reason=String(e.reason??""),e.durationMs!==void 0&&(n._duration_ms=String(e.durationMs));break;case"lifecycle":n._event=String(e.event??""),e.performanceTime!==void 0&&(n._performance_time=String(e.performanceTime)),e.visibilityState&&(n._visibility_state=String(e.visibilityState));break;case"console":if(n._level=String(e.level??"log"),n._message=String(e.message??""),e.args&&Array.isArray(e.args)){let r=e.args;r.length>0&&(n._args=JSON.stringify(r.slice(0,5)))}break;case"resourceError":n._resource_type=String(e.resourceType??"unknown"),n._url=String(e.url??""),n._tag_name=String(e.tagName??"");break;case"userInteraction":n._interaction_type=String(e.interactionType??""),n._tag_name=String(e.tagName??""),n._is_clickable=String(e.isClickable??!1),e.elementId&&(n._element_id=String(e.elementId)),e.className&&(n._class_name=String(e.className)),e.textContent&&(n._text_content=String(e.textContent)),e.clickCount!==void 0&&(n._click_count=String(e.clickCount)),e.timeWindowMs!==void 0&&(n._time_window_ms=String(e.timeWindowMs)),e.duration!==void 0&&(n._duration=String(e.duration));break;case"bridgeReady":n._url=String(e.url??""),e.instrumentationConfig&&(n._config=JSON.stringify(e.instrumentationConfig));break;case"internalAutoInstrumentation":n._event=String(e.event??"");break;case"webVital":{let r=e.metric;if(r){n._metric=String(r.name??""),n._value=String(r.value??""),n._rating=String(r.rating??""),r.delta!==void 0&&(n._delta=String(r.delta)),r.id&&(n._metric_id=String(r.id)),r.navigationType&&(n._navigation_type=String(r.navigationType)),e.parentSpanId&&(n._span_parent_id=String(e.parentSpanId));let i=r.entries?.[0];if(i){if(i.startTime!==void 0&&(n._start_time=String(i.startTime)),i.entryType&&(n._entry_type=String(i.entryType)),"element"in i&&i.element){let o=i.element,a=o.tagName?`${'$'}{o.tagName.toLowerCase()}${'$'}{o.id?"#"+o.id:""}${'$'}{o.className?"."+o.className.split(" ").join("."):""}`:o.toString();n._element=a}"url"in i&&i.url&&(n._url=String(i.url)),"size"in i&&i.size!==void 0&&(n._size=String(i.size)),"renderTime"in i&&i.renderTime!==void 0&&(n._render_time=String(i.renderTime)),"loadTime"in i&&i.loadTime!==void 0&&(n._load_time=String(i.loadTime)),"name"in i&&i.name&&r.name==="FCP"&&(n._paint_type=String(i.name)),"domainLookupStart"in i&&i.domainLookupStart!==void 0&&(n._dns_start=String(i.domainLookupStart)),"domainLookupEnd"in i&&i.domainLookupEnd!==void 0&&(n._dns_end=String(i.domainLookupEnd)),"connectStart"in i&&i.connectStart!==void 0&&(n._connect_start=String(i.connectStart)),"connectEnd"in i&&i.connectEnd!==void 0&&(n._connect_end=String(i.connectEnd)),"secureConnectionStart"in i&&i.secureConnectionStart!==void 0&&(n._tls_start=String(i.secureConnectionStart)),"requestStart"in i&&i.requestStart!==void 0&&(n._request_start=String(i.requestStart)),"responseStart"in i&&i.responseStart!==void 0&&(n._response_start=String(i.responseStart)),"processingStart"in i&&i.processingStart!==void 0&&(n._processing_start=String(i.processingStart)),"processingEnd"in i&&i.processingEnd!==void 0&&(n._processing_end=String(i.processingEnd)),"duration"in i&&i.duration!==void 0&&(n._duration=String(i.duration)),"interactionId"in i&&i.interactionId!==void 0&&(n._interaction_id=String(i.interactionId)),"name"in i&&i.name&&r.name==="INP"&&(n._event_type=String(i.name))}if(r.name==="CLS"&&r.entries&&r.entries.length>0){let o=0,a=0;for(let c of r.entries){let u="value"in c?c.value:0;u>o&&(o=u,a=c.startTime??0)}o>0&&(n._largest_shift_value=String(o),n._largest_shift_time=String(a)),n._shift_count=String(r.entries.length)}}break}case"customLog":e.fields&&typeof e.fields=="object"&&Object.assign(n,e.fields);break}return n},l=({type:t,timestamp:e,...n})=>{let r=e??Date.now(),i=Ve(r),o=Xe(t,n);return{tag:"bitdrift-webview-sdk",v:1,timestamp:r,type:t,...n,fields:{...i,...o}}},se=t=>typeof t=="object"&&t!==null&&"type"in t&&typeof t.type=="string"&&"v"in t&&typeof t.v=="number"&&"tag"in t&&t.tag==="bitdrift-webview-sdk";var pe=-1,_=t=>{addEventListener("pageshow",(e=>{e.persisted&&(pe=e.timeStamp,t(e))}),!0)},w=(t,e,n,r)=>{let i,o;return a=>{e.value>=0&&(a||r)&&(o=e.value-(i??0),(o||i===void 0)&&(i=e.value,e.delta=o,e.rating=((c,u)=>c>u[1]?"poor":c>u[0]?"needs-improvement":"good")(e.value,n),t(e)))}},J=t=>{requestAnimationFrame((()=>requestAnimationFrame((()=>t()))))},K=()=>{let t=performance.getEntriesByType("navigation")[0];if(t&&t.responseStart>0&&t.responseStart<performance.now())return t},I=()=>K()?.activationStart??0,h=(t,e=-1)=>{let n=K(),r="navigate";return pe>=0?r="back-forward-cache":n&&(document.prerendering||I()>0?r="prerender":document.wasDiscarded?r="restore":n.type&&(r=n.type.replace(/_/g,"-"))),{name:t,value:e,rating:"good",delta:0,entries:[],id:`v5-${'$'}{Date.now()}-${'$'}{Math.floor(8999999999999*Math.random())+1e12}`,navigationType:r}},H=new WeakMap;function Y(t,e){return H.get(t)||H.set(t,new e),H.get(t)}var W=class{constructor(){y(this,"t");y(this,"i",0);y(this,"o",[])}h(e){if(e.hadRecentInput)return;let n=this.o[0],r=this.o.at(-1);this.i&&n&&r&&e.startTime-r.startTime<1e3&&e.startTime-n.startTime<5e3?(this.i+=e.value,this.o.push(e)):(this.i=e.value,this.o=[e]),this.t?.(e)}},R=(t,e,n={})=>{try{if(PerformanceObserver.supportedEntryTypes.includes(t)){let r=new PerformanceObserver((i=>{Promise.resolve().then((()=>{e(i.getEntries())}))}));return r.observe({type:t,buffered:!0,...n}),r}}catch{}},Z=t=>{let e=!1;return()=>{e||(t(),e=!0)}},b=-1,we=new Set,ae=()=>document.visibilityState!=="hidden"||document.prerendering?1/0:0,X=t=>{if(document.visibilityState==="hidden"){if(t.type==="visibilitychange")for(let e of we)e();isFinite(b)||(b=t.type==="visibilitychange"?t.timeStamp:0,removeEventListener("prerenderingchange",X,!0))}},B=()=>{if(b<0){let t=I();b=(document.prerendering?void 0:globalThis.performance.getEntriesByType("visibility-state").filter((n=>n.name==="hidden"&&n.startTime>t))[0]?.startTime)??ae(),addEventListener("visibilitychange",X,!0),addEventListener("prerenderingchange",X,!0),_((()=>{setTimeout((()=>{b=ae()}))}))}return{get firstHiddenTime(){return b},onHidden(t){we.add(t)}}},D=t=>{document.prerendering?addEventListener("prerenderingchange",(()=>t()),!0):t()},ce=[1800,3e3],Q=(t,e={})=>{D((()=>{let n=B(),r,i=h("FCP"),o=R("paint",(a=>{for(let c of a)c.name==="first-contentful-paint"&&(o.disconnect(),c.startTime<n.firstHiddenTime&&(i.value=Math.max(c.startTime-I(),0),i.entries.push(c),r(!0)))}));o&&(r=w(t,i,ce,e.reportAllChanges),_((a=>{i=h("FCP"),r=w(t,i,ce,e.reportAllChanges),J((()=>{i.value=performance.now()-a.timeStamp,r(!0)}))})))}))},le=[.1,.25],he=(t,e={})=>{let n=B();Q(Z((()=>{let r,i=h("CLS",0),o=Y(e,W),a=u=>{for(let f of u)o.h(f);o.i>i.value&&(i.value=o.i,i.entries=o.o,r())},c=R("layout-shift",a);c&&(r=w(t,i,le,e.reportAllChanges),n.onHidden((()=>{a(c.takeRecords()),r(!0)})),_((()=>{o.i=0,i=h("CLS",0),r=w(t,i,le,e.reportAllChanges),J((()=>r()))})),setTimeout(r))})))},ye=0,V=1/0,q=0,${'$'}e=t=>{for(let e of t)e.interactionId&&(V=Math.min(V,e.interactionId),q=Math.max(q,e.interactionId),ye=q?(q-V)/7+1:0)},${'$'},de=()=>${'$'}?ye:performance.interactionCount??0,je=()=>{"interactionCount"in performance||${'$'}||(${'$'}=R("event",${'$'}e,{type:"event",buffered:!0,durationThreshold:0}))},ue=0,j=class{constructor(){y(this,"u",[]);y(this,"l",new Map);y(this,"m");y(this,"p")}v(){ue=de(),this.u.length=0,this.l.clear()}L(){let e=Math.min(this.u.length-1,Math.floor((de()-ue)/50));return this.u[e]}h(e){if(this.m?.(e),!e.interactionId&&e.entryType!=="first-input")return;let n=this.u.at(-1),r=this.l.get(e.interactionId);if(r||this.u.length<10||e.duration>n.P){if(r?e.duration>r.P?(r.entries=[e],r.P=e.duration):e.duration===r.P&&e.startTime===r.entries[0].startTime&&r.entries.push(e):(r={id:e.interactionId,entries:[e],P:e.duration},this.l.set(r.id,r),this.u.push(r)),this.u.sort(((i,o)=>o.P-i.P)),this.u.length>10){let i=this.u.splice(10);for(let o of i)this.l.delete(o.id)}this.p?.(r)}}},ve=t=>{let e=globalThis.requestIdleCallback||setTimeout;document.visibilityState==="hidden"?t():(t=Z(t),addEventListener("visibilitychange",t,{once:!0,capture:!0}),e((()=>{t(),removeEventListener("visibilitychange",t,{capture:!0})})))},fe=[200,500],Se=(t,e={})=>{if(!globalThis.PerformanceEventTiming||!("interactionId"in PerformanceEventTiming.prototype))return;let n=B();D((()=>{je();let r,i=h("INP"),o=Y(e,j),a=u=>{ve((()=>{for(let p of u)o.h(p);let f=o.L();f&&f.P!==i.value&&(i.value=f.P,i.entries=f.entries,r())}))},c=R("event",a,{durationThreshold:e.durationThreshold??40});r=w(t,i,fe,e.reportAllChanges),c&&(c.observe({type:"first-input",buffered:!0}),n.onHidden((()=>{a(c.takeRecords()),r(!0)})),_((()=>{o.v(),i=h("INP"),r=w(t,i,fe,e.reportAllChanges)})))}))},z=class{constructor(){y(this,"m")}h(e){this.m?.(e)}},ge=[2500,4e3],be=(t,e={})=>{D((()=>{let n=B(),r,i=h("LCP"),o=Y(e,z),a=u=>{e.reportAllChanges||(u=u.slice(-1));for(let f of u)o.h(f),f.startTime<n.firstHiddenTime&&(i.value=Math.max(f.startTime-I(),0),i.entries=[f],r())},c=R("largest-contentful-paint",a);if(c){r=w(t,i,ge,e.reportAllChanges);let u=Z((()=>{a(c.takeRecords()),c.disconnect(),r(!0)})),f=p=>{p.isTrusted&&(ve(u),removeEventListener(p.type,f,{capture:!0}))};for(let p of["keydown","click","visibilitychange"])addEventListener(p,f,{capture:!0});_((p=>{i=h("LCP"),r=w(t,i,ge,e.reportAllChanges),J((()=>{i.value=performance.now()-p.timeStamp,r(!0)}))}))}}))},me=[800,1800],G=t=>{document.prerendering?D((()=>G(t))):document.readyState!=="complete"?addEventListener("load",(()=>G(t)),!0):setTimeout(t)},_e=(t,e={})=>{let n=h("TTFB"),r=w(t,n,me,e.reportAllChanges);G((()=>{let i=K();i&&(n.value=Math.max(i.responseStart-I(),0),n.entries=[i],r(!0),_((()=>{n=h("TTFB",0),r=w(t,n,me,e.reportAllChanges),r(!0)})))}))};var v=null,P=0,ze=()=>typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,t=>{let e=Math.random()*16|0;return(t==="x"?e:e&3|8).toString(16)}),Te=()=>v,T=(t,e="navigation")=>{s(()=>{v&&O("navigation"),v=ze(),e==="initial"?P=Math.round(performance.timeOrigin):P=Date.now();let n=l({type:"pageView",action:"start",spanId:v,url:t,reason:e,timestamp:P});d(n)})},O=t=>{s(()=>{if(!v)return;let e=Date.now(),n=e-P,r=l({type:"pageView",action:"end",spanId:v,url:window.location.href,reason:t,durationMs:n,timestamp:e});d(r),v=null,P=0})},x=(t,e)=>{s(()=>{let n=l({type:"lifecycle",event:t,performanceTime:performance.now(),...e});d(n)})},ke=()=>{s(()=>{T(window.location.href,"initial"),document.readyState==="loading"?document.addEventListener("DOMContentLoaded",g(()=>{x("DOMContentLoaded")})):x("DOMContentLoaded"),document.readyState!=="complete"?window.addEventListener("load",g(()=>{x("load")})):x("load"),document.addEventListener("visibilitychange",g(()=>{x("visibilitychange",{visibilityState:document.visibilityState}),document.visibilityState==="hidden"?O("hidden"):document.visibilityState==="visible"&&!v&&T(window.location.href,"navigation")})),window.addEventListener("pagehide",g(()=>{O("unload")})),window.addEventListener("beforeunload",g(()=>{O("unload")}))})};var Ce=()=>{s(()=>{let t=g(e=>{let n=Te(),r=l({type:"webVital",metric:e,...n&&{parentSpanId:n}});d(r)});be(t),he(t),Se(t),Q(t),_e(t)})};var Ge=0,te=()=>`req_${'$'}{Date.now()}_${'$'}{++Ge}`,k=new Map,C=new Map,E=new Map,M=5e3,U=t=>{if(k.set(t,Date.now()),k.size>100){let e=Date.now();for(let[n,r]of k.entries())e-r>M&&k.delete(n)}},Je=(t,e)=>{let n=k.get(t);if(n===void 0)return!1;let r=performance.timeOrigin+e;return Math.abs(r-n)<M?(k.delete(t),!0):!1},Ke=t=>{if(C.set(t,Date.now()),C.size>100){let e=Date.now();for(let[n,r]of C.entries())e-r>M&&C.delete(n)}},Ee=t=>{let e=C.get(t);return e===void 0?!1:Date.now()-e<M?!0:(C.delete(t),!1)},Me=(t,e,n)=>{if(E.set(t,{timestamp:Date.now(),resourceType:e,tagName:n}),E.size>100){let r=Date.now();for(let[i,o]of E.entries())r-o.timestamp>M&&E.delete(i)}},Ye=t=>{let e=E.get(t);return e&&Date.now()-e.timestamp<M?(E.delete(t),{failed:!0,resourceType:e.resourceType,tagName:e.tagName}):{failed:!1}},ee=t=>s(()=>typeof performance>"u"||!performance.getEntriesByType?void 0:performance.getEntriesByType("resource").filter(r=>r.name===t).pop()),Ze=()=>{s(()=>{let t=window.fetch;t&&(window.fetch=async(e,n)=>{let r=te(),i=performance.now(),{url:o,method:a}=s(()=>{let c,u;return e instanceof Request?(c=e.url,u=e.method):(c=e.toString(),u=n?.method??"GET"),{url:c,method:u}})??{url:"",method:"GET"};try{let c=await t.call(window,e,n);return s(()=>{let u=performance.now();U(o);let f=l({type:"networkRequest",requestId:r,method:a.toUpperCase(),url:o,statusCode:c.status,durationMs:Math.round(u-i),success:c.ok,requestType:"fetch",timing:ee(o)});d(f)}),c}catch(c){throw s(()=>{let u=performance.now();U(o);let f=l({type:"networkRequest",requestId:r,method:a.toUpperCase(),url:o,statusCode:0,durationMs:Math.round(u-i),success:!1,error:c instanceof Error?c.message:String(c),requestType:"fetch",timing:ee(o)});d(f)}),c}})})},Qe=()=>{s(()=>{let t=XMLHttpRequest.prototype.open,e=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.open=function(n,r,i=!0,o,a){s(()=>{this._bitdrift={method:n.toUpperCase(),url:r.toString(),requestId:te()}}),t.call(this,n,r,i,o,a)},XMLHttpRequest.prototype.send=function(n){let r=this,i=r._bitdrift;if(!i){e.call(this,n);return}let o=performance.now(),a=g(()=>{let u=performance.now();U(i.url);let f=l({type:"networkRequest",requestId:i.requestId,method:i.method,url:i.url,statusCode:r.status,durationMs:Math.round(u-o),success:r.status>=200&&r.status<400,requestType:"xmlhttprequest",timing:ee(i.url)});d(f)}),c=g(()=>{let u=performance.now();U(i.url);let f=l({type:"networkRequest",requestId:i.requestId,method:i.method,url:i.url,statusCode:0,durationMs:Math.round(u-o),success:!1,error:"Network error",requestType:"xmlhttprequest"});d(f)});r.addEventListener("load",a),r.addEventListener("error",c),r.addEventListener("abort",c),r.addEventListener("timeout",c),e.call(this,n)}})},et=()=>{if(!(typeof PerformanceObserver>"u"))try{new PerformanceObserver(g(e=>{let n=e.getEntries();queueMicrotask(g(()=>{for(let r of n)s(()=>{if(Je(r.name,r.responseEnd)||r.name.startsWith("data:")||r.name.startsWith("blob:"))return;let i=Math.round(r.responseEnd-r.startTime),o=r.responseStatus??0,a=o===0?Ye(r.name):{failed:!1},c=o>0?o>=200&&o<400:!a.failed,u=l({type:"networkRequest",requestId:te(),method:"GET",url:r.name,statusCode:o,durationMs:i,success:c,requestType:r.initiatorType,timing:r});Ke(r.name),d(u)})}))})).observe({type:"resource",buffered:!1})}catch{}},Le=()=>{Ze(),Qe(),et()};var S="",Ie=()=>{s(()=>{S=window.location.href;let t=history.pushState;history.pushState=function(n,r,i){t.call(this,n,r,i),s(()=>{let o=S,a=window.location.href;o!==a&&(S=a,ne(o,a,"pushState"),T(a,"navigation"))})};let e=history.replaceState;history.replaceState=function(n,r,i){e.call(this,n,r,i),s(()=>{let o=S,a=window.location.href;o!==a&&(S=a,ne(o,a,"replaceState"),T(a,"navigation"))})},window.addEventListener("popstate",g(()=>{let n=S,r=window.location.href;n!==r&&(S=r,ne(n,r,"popstate"),T(r,"navigation"))}))})},ne=(t,e,n)=>{let r=l({type:"navigation",fromUrl:t,toUrl:e,method:n});d(r)};var Re=()=>{if(!(typeof PerformanceObserver>"u"))try{new PerformanceObserver(g(e=>{for(let n of e.getEntries())s(()=>{let i=n.attribution?.[0],o=l({type:"longTask",durationMs:n.duration,startTime:n.startTime,attribution:i});d(o)})})).observe({type:"longtask",buffered:!0})}catch{}};var tt=500,xe=()=>{s(()=>{window.addEventListener("error",g(t=>{if(t instanceof ErrorEvent)return;let e=t.target;if(!e)return;let n=e.tagName?.toLowerCase();if(!n||!["img","script","link","video","audio","source","iframe"].includes(n))return;let i=e.src||e.href||"";if(!i)return;let o=nt(n,e);Me(i,o,n),setTimeout(g(()=>{if(Ee(i))return;let a=l({type:"resourceError",resourceType:o,url:i,tagName:n});d(a)}),tt)}),!0)})},nt=(t,e)=>{switch(t){case"img":return"image";case"script":return"script";case"link":{let n=e.rel;return n==="stylesheet"?"stylesheet":n==="icon"||n==="shortcut icon"?"icon":"link"}case"video":return"video";case"audio":return"audio";case"source":return"media-source";case"iframe":return"iframe";default:return t}};var rt=["log","warn","error","info","debug"],Ae=()=>{s(()=>{for(let t of rt)N.console[t]=N.console[t]??console[t],console[t]=(...e)=>{s(()=>N.console[t]?.apply(console,e)),s(()=>{if(se(e[0]))return;let n=Pe(e[0]),r=e.length>1?e.slice(1).map(Pe).filter(Boolean):void 0,i=l({type:"console",level:t,message:n,args:r});d(i)})}})},Pe=t=>{if(t===null)return"null";if(t===void 0)return"undefined";if(typeof t=="string")return t;if(typeof t=="number"||typeof t=="boolean")return String(t);if(t instanceof Error)return`${'$'}{t.name}: ${'$'}{t.message}`;try{return JSON.stringify(t,null,0)}catch{return String(t)}};var it=new Set(["a","button","input","select","textarea","label","summary"]),ot=3,qe=1e3,st=100,at=500,A=[],L=null,m=null,Ne=()=>{if(L!==null&&(clearTimeout(L),L=null),m){let t=m.clicks[m.clicks.length-1].timestamp-m.clicks[0].timestamp;De(m.element,"rageClick",!1,m.clicks.length,t),m=null,A=[]}},Be=()=>{s(()=>{document.addEventListener("pointerdown",g(lt),!0)})},ct=t=>s(()=>{let e=t;for(;e;){let n=e.tagName.toLowerCase();if(it.has(n))return!0;let r=e.getAttribute("role");if(r==="button"||r==="link"||r==="menuitem"||e.hasAttribute("onclick")||e.hasAttribute("tabindex")||window.getComputedStyle(e).cursor==="pointer")return!0;e=e.parentElement}return!1})??!1,lt=t=>{let e=t.target;if(!e)return;let n=ct(e),r=Date.now();if(n)De(e,"click",!0);else{let i={x:t.clientX,y:t.clientY,timestamp:r,element:e};A.push(i),A=A.filter(a=>r-a.timestamp<qe);let o=A.filter(a=>Math.sqrt((a.x-t.clientX)**2+(a.y-t.clientY)**2)<st);o.length>=ot&&(m&&m.element===e?m.clicks=o:(m&&Ne(),m={element:e,clicks:o}),L!==null&&clearTimeout(L),L=setTimeout(()=>{Ne()},at))}},De=(t,e,n,r,i)=>{s(()=>{let o=t.tagName.toLowerCase(),a=t.id||void 0,c=t.className?typeof t.className=="string"?t.className:t.className.toString():void 0,u=t.hasAttribute("data-redacted"),f;if(u)f="<redacted>";else if(t.textContent){let F=t.textContent.trim().replace(/\s+/g," ");f=F.length>50?`${'$'}{F.slice(0,50)}...`:F||void 0}let p=l({type:"userInteraction",interactionType:e,tagName:o,elementId:a,className:c?.slice(0,100),textContent:f,isClickable:n,clickCount:e==="rageClick"?r:void 0,timeWindowMs:e==="rageClick"?qe:void 0,duration:e==="rageClick"?i:void 0});d(p)})};var Oe=()=>{s(()=>{window.addEventListener("error",g(t=>{if(t.target&&t.target!==window)return;let e=t.error,n;e instanceof Error&&(n=e.stack);let r=l({type:"error",name:e?.name??"Error",message:t.message||"Unknown error",stack:n,filename:t.filename||void 0,lineno:t.lineno||void 0,colno:t.colno||void 0});d(r)}))})},Ue=()=>{s(()=>{window.addEventListener("unhandledrejection",g(t=>{let e="Unknown rejection reason",n;if(t.reason instanceof Error)e=t.reason.message,n=t.reason.stack;else if(typeof t.reason=="string")e=t.reason;else if(t.reason!==null&&t.reason!==void 0)try{e=JSON.stringify(t.reason)}catch{e=String(t.reason)}let r=l({type:"promiseRejection",reason:e,stack:n});d(r)}))})};var dt=t=>{s(()=>{window.__bitdriftBridgeInitialized||(window.__bitdriftBridgeInitialized=!0,window.bitdrift=window.bitdrift||{},window.bitdrift.config=t,oe(),d(l({type:"bridgeReady",url:window.location.href,instrumentationConfig:window.bitdrift.config})),window.bitdrift.config?.capturePageViews&&(s(()=>ke()),d(l({type:"internalAutoInstrumentation",event:"capturePageViews"}))),window.bitdrift.config?.captureNetworkRequests&&(s(()=>Le()),d(l({type:"internalAutoInstrumentation",event:"captureNetworkRequests"}))),window.bitdrift.config?.captureNavigationEvents&&(s(()=>Ie()),d(l({type:"internalAutoInstrumentation",event:"captureNavigationEvents"}))),window.bitdrift.config?.captureWebVitals&&(s(()=>Ce()),d(l({type:"internalAutoInstrumentation",event:"captureWebVitals"}))),window.bitdrift.config?.captureLongTasks&&(s(()=>Re()),d(l({type:"internalAutoInstrumentation",event:"captureLongTasks"}))),window.bitdrift.config?.captureConsoleLogs&&(s(()=>Ae()),d(l({type:"internalAutoInstrumentation",event:"captureConsoleLogs"}))),window.bitdrift.config?.captureUserInteractions&&(s(()=>Be()),d(l({type:"internalAutoInstrumentation",event:"captureUserInteractions"}))),window.bitdrift.config?.captureErrors&&(s(()=>xe()),s(()=>Ue()),s(()=>Oe()),d(l({type:"internalAutoInstrumentation",event:"captureErrors"}))))})};dt("""

    private const val SCRIPT_SUFFIX: String = """);})();
})();

"""

    /**
     * Generates the JavaScript bundle with the provided configuration.
     *
     * @param config The WebView instrumentation configuration
     * @return The complete JavaScript bundle with config injected
     */
    fun getScript(config: WebViewConfiguration): String = SCRIPT_PREFIX + config.toJson() + SCRIPT_SUFFIX
}
