// capture-sdk - bitdrift's client SDK
// Copyright Bitdrift, Inc. All rights reserved.
//
// Use of this source code is governed by a source available license that can be found in the
// LICENSE file or at:
// https://polyformproject.org/wp-content/uploads/2020/06/PolyForm-Shield-1.0.0.txt

// AUTO-GENERATED FILE - DO NOT EDIT
// Generated by: npm run generate
// Source: platform/webview/src/

package io.bitdrift.capture.webview

/**
 * Contains the bundled JavaScript SDK for WebView instrumentation.
 * This script is injected into WebViews to capture performance metrics,
 * network events, and user interactions.
 */
internal object WebViewBridgeScript {
    /**
     * The minified JavaScript bundle to inject into WebViews.
     */
    const val SCRIPT: String = """
(function() {
"use strict";var BitdriftWebView=(()=>{var Ae=Object.defineProperty;var Ne=(e,t,r)=>t in e?Ae(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var h=(e,t,r)=>Ne(e,typeof t!="symbol"?t+"":t,r);var L={console:{log:console.log,warn:console.warn,error:console.error,info:console.info,debug:console.debug}},De=()=>window.webkit?.messageHandlers?.BitdriftLogger?"ios":window.BitdriftLogger?"android":"unknown",Z=e=>{let t=De(),r=JSON.stringify(e);switch(t){case"ios":window.webkit?.messageHandlers?.BitdriftLogger?.postMessage(e);break;case"android":window.BitdriftLogger?.log(r);break;case"unknown":typeof console<"u"&&console.debug("[Bitdrift WebView]",e);break}},ee=()=>{window.bitdrift||(window.bitdrift={log:Z})},c=e=>{window.bitdrift?(L.console.log("[Bitdrift WebView] Logging message via bridge",e),window.bitdrift.log(e)):Z(e)},u=e=>({tag:"bitdrift-webview-sdk",v:1,timestamp:Date.now(),...e}),te=e=>typeof e=="object"&&e!==null&&"type"in e&&typeof e.type=="string"&&"v"in e&&typeof e.v=="number"&&"tag"in e&&e.tag==="bitdrift-webview-sdk";var le=-1,b=e=>{addEventListener("pageshow",(t=>{t.persisted&&(le=t.timeStamp,e(t))}),!0)},f=(e,t,r,n)=>{let i,o;return s=>{t.value>=0&&(s||n)&&(o=t.value-(i??0),(o||i===void 0)&&(i=t.value,t.delta=o,t.rating=((a,l)=>a>l[1]?"poor":a>l[0]?"needs-improvement":"good")(t.value,r),e(t)))}},z=e=>{requestAnimationFrame((()=>requestAnimationFrame((()=>e()))))},${'$'}=()=>{let e=performance.getEntriesByType("navigation")[0];if(e&&e.responseStart>0&&e.responseStart<performance.now())return e},C=()=>${'$'}()?.activationStart??0,p=(e,t=-1)=>{let r=${'$'}(),n="navigate";return le>=0?n="back-forward-cache":r&&(document.prerendering||C()>0?n="prerender":document.wasDiscarded?n="restore":r.type&&(n=r.type.replace(/_/g,"-"))),{name:e,value:t,rating:"good",delta:0,entries:[],id:`v5-${'$'}{Date.now()}-${'$'}{Math.floor(8999999999999*Math.random())+1e12}`,navigationType:n}},_=new WeakMap;function G(e,t){return _.get(e)||_.set(e,new t),_.get(e)}var H=class{constructor(){h(this,"t");h(this,"i",0);h(this,"o",[])}h(t){if(t.hadRecentInput)return;let r=this.o[0],n=this.o.at(-1);this.i&&r&&n&&t.startTime-n.startTime<1e3&&t.startTime-r.startTime<5e3?(this.i+=t.value,this.o.push(t)):(this.i=t.value,this.o=[t]),this.t?.(t)}},x=(e,t,r={})=>{try{if(PerformanceObserver.supportedEntryTypes.includes(e)){let n=new PerformanceObserver((i=>{Promise.resolve().then((()=>{t(i.getEntries())}))}));return n.observe({type:e,buffered:!0,...r}),n}}catch{}},K=e=>{let t=!1;return()=>{t||(e(),t=!0)}},v=-1,ue=new Set,ne=()=>document.visibilityState!=="hidden"||document.prerendering?1/0:0,U=e=>{if(document.visibilityState==="hidden"){if(e.type==="visibilitychange")for(let t of ue)t();isFinite(v)||(v=e.type==="visibilitychange"?e.timeStamp:0,removeEventListener("prerenderingchange",U,!0))}},B=()=>{if(v<0){let e=C();v=(document.prerendering?void 0:globalThis.performance.getEntriesByType("visibility-state").filter((r=>r.name==="hidden"&&r.startTime>e))[0]?.startTime)??ne(),addEventListener("visibilitychange",U,!0),addEventListener("prerenderingchange",U,!0),b((()=>{setTimeout((()=>{v=ne()}))}))}return{get firstHiddenTime(){return v},onHidden(e){ue.add(e)}}},q=e=>{document.prerendering?addEventListener("prerenderingchange",(()=>e()),!0):e()},re=[1800,3e3],J=(e,t={})=>{q((()=>{let r=B(),n,i=p("FCP"),o=x("paint",(s=>{for(let a of s)a.name==="first-contentful-paint"&&(o.disconnect(),a.startTime<r.firstHiddenTime&&(i.value=Math.max(a.startTime-C(),0),i.entries.push(a),n(!0)))}));o&&(n=f(e,i,re,t.reportAllChanges),b((s=>{i=p("FCP"),n=f(e,i,re,t.reportAllChanges),z((()=>{i.value=performance.now()-s.timeStamp,n(!0)}))})))}))},ie=[.1,.25],ge=(e,t={})=>{let r=B();J(K((()=>{let n,i=p("CLS",0),o=G(t,H),s=l=>{for(let d of l)o.h(d);o.i>i.value&&(i.value=o.i,i.entries=o.o,n())},a=x("layout-shift",s);a&&(n=f(e,i,ie,t.reportAllChanges),r.onHidden((()=>{s(a.takeRecords()),n(!0)})),b((()=>{o.i=0,i=p("CLS",0),n=f(e,i,ie,t.reportAllChanges),z((()=>n()))})),setTimeout(n))})))},me=0,O=1/0,P=0,_e=e=>{for(let t of e)t.interactionId&&(O=Math.min(O,t.interactionId),P=Math.max(P,t.interactionId),me=P?(P-O)/7+1:0)},V,oe=()=>V?me:performance.interactionCount??0,Oe=()=>{"interactionCount"in performance||V||(V=x("event",_e,{type:"event",buffered:!0,durationThreshold:0}))},se=0,F=class{constructor(){h(this,"u",[]);h(this,"l",new Map);h(this,"m");h(this,"p")}v(){se=oe(),this.u.length=0,this.l.clear()}L(){let t=Math.min(this.u.length-1,Math.floor((oe()-se)/50));return this.u[t]}h(t){if(this.m?.(t),!t.interactionId&&t.entryType!=="first-input")return;let r=this.u.at(-1),n=this.l.get(t.interactionId);if(n||this.u.length<10||t.duration>r.P){if(n?t.duration>n.P?(n.entries=[t],n.P=t.duration):t.duration===n.P&&t.startTime===n.entries[0].startTime&&n.entries.push(t):(n={id:t.interactionId,entries:[t],P:t.duration},this.l.set(n.id,n),this.u.push(n)),this.u.sort(((i,o)=>o.P-i.P)),this.u.length>10){let i=this.u.splice(10);for(let o of i)this.l.delete(o.id)}this.p?.(n)}}},fe=e=>{let t=globalThis.requestIdleCallback||setTimeout;document.visibilityState==="hidden"?e():(e=K(e),addEventListener("visibilitychange",e,{once:!0,capture:!0}),t((()=>{e(),removeEventListener("visibilitychange",e,{capture:!0})})))},ae=[200,500],pe=(e,t={})=>{if(!globalThis.PerformanceEventTiming||!("interactionId"in PerformanceEventTiming.prototype))return;let r=B();q((()=>{Oe();let n,i=p("INP"),o=G(t,F),s=l=>{fe((()=>{for(let g of l)o.h(g);let d=o.L();d&&d.P!==i.value&&(i.value=d.P,i.entries=d.entries,n())}))},a=x("event",s,{durationThreshold:t.durationThreshold??40});n=f(e,i,ae,t.reportAllChanges),a&&(a.observe({type:"first-input",buffered:!0}),r.onHidden((()=>{s(a.takeRecords()),n(!0)})),b((()=>{o.v(),i=p("INP"),n=f(e,i,ae,t.reportAllChanges)})))}))},W=class{constructor(){h(this,"m")}h(t){this.m?.(t)}},ce=[2500,4e3],he=(e,t={})=>{q((()=>{let r=B(),n,i=p("LCP"),o=G(t,W),s=l=>{t.reportAllChanges||(l=l.slice(-1));for(let d of l)o.h(d),d.startTime<r.firstHiddenTime&&(i.value=Math.max(d.startTime-C(),0),i.entries=[d],n())},a=x("largest-contentful-paint",s);if(a){n=f(e,i,ce,t.reportAllChanges);let l=K((()=>{s(a.takeRecords()),a.disconnect(),n(!0)})),d=g=>{g.isTrusted&&(fe(l),removeEventListener(g.type,d,{capture:!0}))};for(let g of["keydown","click","visibilitychange"])addEventListener(g,d,{capture:!0});b((g=>{i=p("LCP"),n=f(e,i,ce,t.reportAllChanges),z((()=>{i.value=performance.now()-g.timeStamp,n(!0)}))}))}}))},de=[800,1800],X=e=>{document.prerendering?q((()=>X(e))):document.readyState!=="complete"?addEventListener("load",(()=>X(e)),!0):setTimeout(e)},ye=(e,t={})=>{let r=p("TTFB"),n=f(e,r,de,t.reportAllChanges);X((()=>{let i=${'$'}();i&&(r.value=Math.max(i.responseStart-C(),0),r.entries=[i],n(!0),b((()=>{r=p("TTFB",0),n=f(e,r,de,t.reportAllChanges),n(!0)})))}))};var y=null,I=0,He=()=>typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)}),we=()=>y,M=(e,t="navigation")=>{y&&A("navigation"),y=He(),t==="initial"?I=Math.round(performance.timeOrigin):I=Date.now(),c({tag:"bitdrift-webview-sdk",v:1,type:"pageView",action:"start",spanId:y,url:e,reason:t,timestamp:I})},A=e=>{if(!y)return;let t=Date.now(),r=t-I,n={tag:"bitdrift-webview-sdk",v:1,timestamp:t,type:"pageView",action:"end",spanId:y,url:window.location.href,reason:e,durationMs:r};c(n),y=null,I=0},S=(e,t)=>{let r=u({type:"lifecycle",event:e,performanceTime:performance.now(),...t});c(r)},ve=()=>{M(window.location.href,"initial"),document.readyState==="loading"?document.addEventListener("DOMContentLoaded",()=>{S("DOMContentLoaded")}):S("DOMContentLoaded"),document.readyState!=="complete"?window.addEventListener("load",()=>{S("load")}):S("load"),document.addEventListener("visibilitychange",()=>{S("visibilitychange",{visibilityState:document.visibilityState}),document.visibilityState==="hidden"?A("hidden"):document.visibilityState==="visible"&&!y&&M(window.location.href,"navigation")}),window.addEventListener("pagehide",()=>{A("unload")}),window.addEventListener("beforeunload",()=>{A("unload")})};var be=()=>{let e=t=>{let r=we(),n=u({type:"webVital",metric:t,...r&&{parentSpanId:r}});c(n)};he(e),ge(e),pe(e),J(e),ye(e)};var Ue=0,Y=()=>`req_${'$'}{Date.now()}_${'$'}{++Ue}`,T=new Map,E=new Map,D=5e3,N=e=>{if(T.set(e,Date.now()),T.size>100){let t=Date.now();for(let[r,n]of T.entries())t-n>D&&T.delete(r)}},Ve=(e,t)=>{let r=T.get(e);if(r===void 0)return!1;let n=performance.timeOrigin+t;return Math.abs(n-r)<D?(T.delete(e),!0):!1},Fe=e=>{if(E.set(e,Date.now()),E.size>100){let t=Date.now();for(let[r,n]of E.entries())t-n>D&&E.delete(r)}},Me=e=>{let t=E.get(e);return t===void 0?!1:Date.now()-t<D?!0:(E.delete(e),!1)},j=e=>typeof performance>"u"||!performance.getEntriesByType?void 0:performance.getEntriesByType("resource").filter(n=>n.name===e).pop(),We=()=>{let e=window.fetch;e&&(window.fetch=async(t,r)=>{let n=Y(),i=performance.now(),o,s;t instanceof Request?(o=t.url,s=t.method):(o=t.toString(),s=r?.method??"GET");try{let a=await e.call(window,t,r),l=performance.now();N(o);let d=u({type:"networkRequest",requestId:n,method:s.toUpperCase(),url:o,statusCode:a.status,durationMs:Math.round(l-i),success:a.ok,requestType:"fetch",timing:j(o)});return c(d),a}catch(a){let l=performance.now();N(o);let d=u({type:"networkRequest",requestId:n,method:s.toUpperCase(),url:o,statusCode:0,durationMs:Math.round(l-i),success:!1,error:a instanceof Error?a.message:String(a),requestType:"fetch",timing:j(o)});throw c(d),a}})},Xe=()=>{let e=XMLHttpRequest.prototype.open,t=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.open=function(r,n,i=!0,o,s){this._bitdrift={method:r.toUpperCase(),url:n.toString(),requestId:Y()},e.call(this,r,n,i,o,s)},XMLHttpRequest.prototype.send=function(r){let n=this,i=n._bitdrift;if(!i){t.call(this,r);return}let o=performance.now(),s=()=>{let l=performance.now();N(i.url);let d=u({type:"networkRequest",requestId:i.requestId,method:i.method,url:i.url,statusCode:n.status,durationMs:Math.round(l-o),success:n.status>=200&&n.status<400,requestType:"xmlhttprequest",timing:j(i.url)});c(d)},a=()=>{let l=performance.now();N(i.url);let d=u({type:"networkRequest",requestId:i.requestId,method:i.method,url:i.url,statusCode:0,durationMs:Math.round(l-o),success:!1,error:"Network error",requestType:"xmlhttprequest"});c(d)};n.addEventListener("load",s),n.addEventListener("error",a),n.addEventListener("abort",a),n.addEventListener("timeout",a),t.call(this,r)}},ze=()=>{if(!(typeof PerformanceObserver>"u"))try{new PerformanceObserver(t=>{for(let r of t.getEntries()){let n=r;if(Ve(n.name,n.responseEnd)||n.name.startsWith("data:")||n.name.startsWith("blob:"))continue;let i=Math.round(n.responseEnd-n.startTime),o=n.responseStatus??0,s=n.responseEnd>0,a=n.decodedBodySize>0||n.transferSize>0,l=o>0?o>=200&&o<400:s&&a,d=u({type:"networkRequest",requestId:Y(),method:"GET",url:n.name,statusCode:o,durationMs:i,success:l,requestType:n.initiatorType,timing:n});Fe(n.name),c(d)}}).observe({type:"resource",buffered:!1})}catch{}},Te=()=>{We(),Xe(),ze()};var w="",Ee=()=>{w=window.location.href;let e=history.pushState;history.pushState=function(r,n,i){let o=w;e.call(this,r,n,i);let s=window.location.href;o!==s&&(w=s,Q(o,s,"pushState"),M(s,"navigation"))};let t=history.replaceState;history.replaceState=function(r,n,i){let o=w;t.call(this,r,n,i);let s=window.location.href;o!==s&&(w=s,Q(o,s,"replaceState"),M(s,"navigation"))},window.addEventListener("popstate",()=>{let r=w,n=window.location.href;r!==n&&(w=n,Q(r,n,"popstate"),M(n,"navigation"))})},Q=(e,t,r)=>{let n=u({type:"navigation",fromUrl:e,toUrl:t,method:r});c(n)};var ke=()=>{if(!(typeof PerformanceObserver>"u"))try{new PerformanceObserver(t=>{for(let r of t.getEntries()){let i=r.attribution?.[0],o=u({type:"longTask",durationMs:r.duration,startTime:r.startTime,attribution:i});c(o)}}).observe({type:"longtask",buffered:!0})}catch{}};var Le=()=>{window.addEventListener("error",e=>{if(e instanceof ErrorEvent)return;let t=e.target;if(!t)return;let r=t.tagName?.toLowerCase();if(!r||!["img","script","link","video","audio","source","iframe"].includes(r))return;let i=t.src||t.href||"";if(!i||Me(i))return;let o=u({type:"resourceError",resourceType:${'$'}e(r,t),url:i,tagName:r});c(o)},!0)},${'$'}e=(e,t)=>{switch(e){case"img":return"image";case"script":return"script";case"link":{let r=t.rel;return r==="stylesheet"?"stylesheet":r==="icon"||r==="shortcut icon"?"icon":"link"}case"video":return"video";case"audio":return"audio";case"source":return"media-source";case"iframe":return"iframe";default:return e}};var Ge=["log","warn","error","info","debug"],xe=()=>{for(let e of Ge)L.console[e]=L.console[e]??console[e],console[e]=(...t)=>{if(L.console[e]?.apply(console,t),te(t[0]))return;let r=Ce(t[0]),n=t.length>1?t.slice(1).map(Ce).filter(Boolean):void 0,i=u({type:"console",level:e,message:r,args:n});c(i)}},Ce=e=>{if(e===null)return"null";if(e===void 0)return"undefined";if(typeof e=="string")return e;if(typeof e=="number"||typeof e=="boolean")return String(e);if(e instanceof Error)return`${'$'}{e.name}: ${'$'}{e.message}`;try{return JSON.stringify(e,null,0)}catch{return String(e)}};var Ke=new Set(["a","button","input","select","textarea","label","summary"]),Je=new Set(["button","submit","reset","checkbox","radio","file"]),je=3,Ie=1e3,Ye=100,Qe=500,R=[],k=null,m=null,Se=()=>{if(k!==null&&(clearTimeout(k),k=null),m){let e=m.clicks[m.clicks.length-1].timestamp-m.clicks[0].timestamp;Pe(m.element,"rageClick",!1,m.clicks.length,e),m=null,R=[]}},Re=()=>{document.addEventListener("pointerdown",et,!0)},Ze=e=>{let t=e;for(;t;){let r=t.tagName.toLowerCase();if(Ke.has(r)){if(r==="input"){let o=t.type.toLowerCase();return Je.has(o)}return!0}let n=t.getAttribute("role");if(n==="button"||n==="link"||n==="menuitem"||t.hasAttribute("onclick")||t.hasAttribute("tabindex")||window.getComputedStyle(t).cursor==="pointer")return!0;t=t.parentElement}return!1},et=e=>{let t=e.target;if(!t)return;let r=Ze(t),n=Date.now();if(r)Pe(t,"click",!0);else{let i={x:e.clientX,y:e.clientY,timestamp:n,element:t};R.push(i),R=R.filter(s=>n-s.timestamp<Ie);let o=R.filter(s=>Math.sqrt((s.x-e.clientX)**2+(s.y-e.clientY)**2)<Ye);o.length>=je&&(m&&m.element===t?m.clicks=o:(m&&Se(),m={element:t,clicks:o}),k!==null&&clearTimeout(k),k=setTimeout(()=>{Se()},Qe))}},Pe=(e,t,r,n,i)=>{let o=e.tagName.toLowerCase(),s=e.id||void 0,a=e.className?typeof e.className=="string"?e.className:e.className.toString():void 0,l;if(e.textContent){let g=e.textContent.trim().replace(/\s+/g," ");l=g.length>50?`${'$'}{g.slice(0,50)}...`:g||void 0}let d=u({type:"userInteraction",interactionType:t,tagName:o,elementId:s,className:a?.slice(0,100),textContent:l,isClickable:r,clickCount:t==="rageClick"?n:void 0,timeWindowMs:t==="rageClick"?Ie:void 0,duration:t==="rageClick"?i:void 0});c(d)};var Be=()=>{window.addEventListener("error",e=>{if(e.target&&e.target!==window)return;let t=e.error,r;t instanceof Error&&(r=t.stack);let n=u({type:"error",name:t?.name??"Error",message:e.message||"Unknown error",stack:r,filename:e.filename||void 0,lineno:e.lineno||void 0,colno:e.colno||void 0});c(n)})},qe=()=>{window.addEventListener("unhandledrejection",e=>{let t="Unknown rejection reason",r;if(e.reason instanceof Error)t=e.reason.message,r=e.reason.stack;else if(typeof e.reason=="string")t=e.reason;else if(e.reason!==null&&e.reason!==void 0)try{t=JSON.stringify(e.reason)}catch{t=String(e.reason)}let n=u({type:"promiseRejection",reason:t,stack:r});c(n)})};var tt=()=>{if(window.__bitdriftBridgeInitialized)return;window.__bitdriftBridgeInitialized=!0,ee();let e=u({type:"bridgeReady",url:window.location.href});c(e),ve(),Te(),Ee(),be(),ke(),Le(),xe(),qe(),Re(),Be()};tt();})();
})();

"""
}
