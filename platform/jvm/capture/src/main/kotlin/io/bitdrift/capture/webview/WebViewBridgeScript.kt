// capture-sdk - bitdrift's client SDK
// Copyright Bitdrift, Inc. All rights reserved.
//
// Use of this source code is governed by a source available license that can be found in the
// LICENSE file or at:
// https://polyformproject.org/wp-content/uploads/2020/06/PolyForm-Shield-1.0.0.txt

// AUTO-GENERATED FILE - DO NOT EDIT
// Generated by: npm run generate
// Source: platform/webview/src/

@file:Suppress("MaxLineLength")

package io.bitdrift.capture.webview

/**
 * Contains the bundled JavaScript SDK for WebView instrumentation.
 * This script is injected into WebViews to capture performance metrics,
 * network events, and user interactions.
 */
internal object WebViewBridgeScript {
    private const val SCRIPT_PREFIX: String = """
(function() {
"use strict";var BitdriftWebView=(()=>{var Fe=Object.defineProperty;var Ve=(e,n,i)=>n in e?Fe(e,n,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[n]=i;var h=(e,n,i)=>Ve(e,typeof n!="symbol"?n+"":n,i);var c=e=>{try{return e()}catch{return}};var m=e=>(...n)=>{try{return e(...n)}catch{return}};var N={console:{log:console.log,warn:console.warn,error:console.error,info:console.info,debug:console.debug}},He=e=>({_source:"webview",_timestamp:(e??Date.now()).toString()}),ie=(e,n="")=>{let i={};for(let[t,r]of Object.entries(e)){if(r==null)continue;let o=t.replace(/[A-Z]/g,l=>`_${'$'}{l.toLowerCase()}`),s=n&&o.startsWith("_")?o.substring(1):o,a=n?`${'$'}{n}.${'$'}{s}`:`_${'$'}{o}`;typeof r=="object"&&!Array.isArray(r)?Object.assign(i,ie(r,a)):i[a]=r.toString()}return i},We=()=>c(()=>window.webkit?.messageHandlers?.BitdriftLogger?"ios":window.BitdriftLogger?"android":"unknown")??"unknown",re=e=>{c(()=>{let n=We(),i=JSON.stringify(e);switch(n){case"ios":window.webkit?.messageHandlers?.BitdriftLogger?.postMessage(e);break;case"android":window.BitdriftLogger?.log(i);break;case"unknown":typeof console<"u"&&console.debug("[Bitdrift WebView]",e);break}})},se=()=>{window.bitdrift?.log||(window.bitdrift={config:window.bitdrift?.config,log:(...e)=>{if(e.length!==1&&e.length!==3)throw new Error("Invalid arguments to bitdrift.log. Expected 1 or 3 arguments.");let n;if(e.length===1)n=e[0];else{let[i,t,r]=e;n=d({type:"customLog",level:i,message:t,fields:r})}re(n)}})},u=e=>{window.bitdrift?window.bitdrift.log?.(e):re(e)},je=(e,n)=>{let i={};switch(e){case"navigation":{let t=n;i._from_url=String(t.fromUrl??""),i._to_url=String(t.toUrl??""),i._method=String(t.method??"");break}case"error":{let t=n;i._name=String(t.name??"Error"),i._message=String(t.message??"Unknown error"),t.stack&&(i._stack=String(t.stack)),t.filename&&(i._filename=String(t.filename)),t.lineno&&(i._lineno=String(t.lineno)),t.colno&&(i._colno=String(t.colno));break}case"promiseRejection":{let t=n;i._reason=String(t.reason??"Unknown rejection"),t.stack&&(i._stack=String(t.stack));break}case"longTask":{let t=n;i._duration_ms=String(t.durationMs??0),i._start_time=String(t.startTime??0),t.attribution&&typeof t.attribution=="object"&&Object.assign(i,ie(t.attribution,"_attribution"));break}case"pageView":{let t=n;i._span_id=String(t.spanId??""),i._url=String(t.url??""),i._reason=String(t.reason??""),t.durationMs!==void 0&&(i._duration_ms=String(t.durationMs));break}case"lifecycle":{let t=n;i._event=String(t.event??""),t.performanceTime!==void 0&&(i._performance_time=String(t.performanceTime)),t.visibilityState&&(i._visibility_state=String(t.visibilityState));break}case"console":{let t=n;i._level=String(t.level??"log"),i._message=String(t.message??""),t.args&&Array.isArray(t.args)&&t.args.length>0&&(i._args=JSON.stringify(t.args.slice(0,5)));break}case"resourceError":{let t=n;i._resource_type=String(t.resourceType??"unknown"),i._url=String(t.url??""),i._tag_name=String(t.tagName??"");break}case"userInteraction":{let t=n;i._interaction_type=String(t.interactionType??""),i._tag_name=String(t.tagName??""),i._is_clickable=String(t.isClickable??!1),t.elementId&&(i._element_id=String(t.elementId)),t.className&&(i._class_name=String(t.className)),t.textContent&&(i._text_content=String(t.textContent)),t.clickCount!==void 0&&(i._click_count=String(t.clickCount)),t.timeWindowMs!==void 0&&(i._time_window_ms=String(t.timeWindowMs)),t.duration!==void 0&&(i._duration=String(t.duration));break}case"bridgeReady":{let t=n;i._url=String(t.url??""),t.instrumentationConfig&&(i._config=JSON.stringify(t.instrumentationConfig));break}case"internalAutoInstrumentation":{let t=n;i._event=String(t.event??"");break}case"webVital":{let t=n,r=t.metric;if(r){i._metric=String(r.name??""),i._value=String(r.value??""),i._rating=String(r.rating??""),r.delta!==void 0&&(i._delta=String(r.delta)),r.id&&(i._metric_id=String(r.id)),r.navigationType&&(i._navigation_type=String(r.navigationType)),t.parentSpanId&&(i._span_parent_id=String(t.parentSpanId));let o=r.entries,s=o?.[0];if(s){if(s.startTime!==void 0&&(i._start_time=String(s.startTime)),s.entryType&&(i._entry_type=String(s.entryType)),"element"in s&&s.element){let a=s.element,l=a.tagName?`${'$'}{a.tagName.toLowerCase()}${'$'}{a.id?"#"+a.id:""}${'$'}{a.className?"."+a.className.split(" ").join("."):""}`:a.toString();i._element=l}"url"in s&&s.url&&(i._url=String(s.url)),"size"in s&&s.size!==void 0&&(i._size=String(s.size)),"renderTime"in s&&s.renderTime!==void 0&&(i._render_time=String(s.renderTime)),"loadTime"in s&&s.loadTime!==void 0&&(i._load_time=String(s.loadTime)),"name"in s&&s.name&&r.name==="FCP"&&(i._paint_type=String(s.name)),"domainLookupStart"in s&&s.domainLookupStart!==void 0&&(i._dns_start=String(s.domainLookupStart)),"domainLookupEnd"in s&&s.domainLookupEnd!==void 0&&(i._dns_end=String(s.domainLookupEnd)),"connectStart"in s&&s.connectStart!==void 0&&(i._connect_start=String(s.connectStart)),"connectEnd"in s&&s.connectEnd!==void 0&&(i._connect_end=String(s.connectEnd)),"secureConnectionStart"in s&&s.secureConnectionStart!==void 0&&(i._tls_start=String(s.secureConnectionStart)),"requestStart"in s&&s.requestStart!==void 0&&(i._request_start=String(s.requestStart)),"responseStart"in s&&s.responseStart!==void 0&&(i._response_start=String(s.responseStart)),"processingStart"in s&&s.processingStart!==void 0&&(i._processing_start=String(s.processingStart)),"processingEnd"in s&&s.processingEnd!==void 0&&(i._processing_end=String(s.processingEnd)),"duration"in s&&s.duration!==void 0&&(i._duration=String(s.duration)),"interactionId"in s&&s.interactionId!==void 0&&(i._interaction_id=String(s.interactionId)),"name"in s&&s.name&&r.name==="INP"&&(i._event_type=String(s.name))}if(r.name==="CLS"&&o&&o.length>0){let a=0,l=0;for(let g of o){let f="value"in g?Number(g.value):0;f>a&&(a=f,l=Number(g.startTime)??0)}a>0&&(i._largest_shift_value=String(a),i._largest_shift_time=String(l)),i._shift_count=String(o.length)}}break}case"customLog":{let t=n;t.fields&&typeof t.fields=="object"&&Object.assign(i,t.fields);break}}return i},d=({type:e,timestamp:n,...i})=>{let t=n??Date.now(),r=He(t),o=je(e,i);return{tag:"bitdrift-webview-sdk",v:1,timestamp:t,type:e,...i,fields:{...r,...o}}},oe=e=>typeof e=="object"&&e!==null&&"type"in e&&typeof e.type=="string"&&"v"in e&&typeof e.v=="number"&&"tag"in e&&e.tag==="bitdrift-webview-sdk";var pe=-1,T=e=>{addEventListener("pageshow",(n=>{n.persisted&&(pe=n.timeStamp,e(n))}),!0)},y=(e,n,i,t)=>{let r,o;return s=>{n.value>=0&&(s||t)&&(o=n.value-(r??0),(o||r===void 0)&&(r=n.value,n.delta=o,n.rating=((a,l)=>a>l[1]?"poor":a>l[0]?"needs-improvement":"good")(n.value,i),e(n)))}},J=e=>{requestAnimationFrame((()=>requestAnimationFrame((()=>e()))))},K=()=>{let e=performance.getEntriesByType("navigation")[0];if(e&&e.responseStart>0&&e.responseStart<performance.now())return e},I=()=>K()?.activationStart??0,w=(e,n=-1)=>{let i=K(),t="navigate";return pe>=0?t="back-forward-cache":i&&(document.prerendering||I()>0?t="prerender":document.wasDiscarded?t="restore":i.type&&(t=i.type.replace(/_/g,"-"))),{name:e,value:n,rating:"good",delta:0,entries:[],id:`v5-${'$'}{Date.now()}-${'$'}{Math.floor(8999999999999*Math.random())+1e12}`,navigationType:t}},V=new WeakMap;function Y(e,n){return V.get(e)||V.set(e,new n),V.get(e)}var W=class{constructor(){h(this,"t");h(this,"i",0);h(this,"o",[])}h(n){if(n.hadRecentInput)return;let i=this.o[0],t=this.o.at(-1);this.i&&i&&t&&n.startTime-t.startTime<1e3&&n.startTime-i.startTime<5e3?(this.i+=n.value,this.o.push(n)):(this.i=n.value,this.o=[n]),this.t?.(n)}},R=(e,n,i={})=>{try{if(PerformanceObserver.supportedEntryTypes.includes(e)){let t=new PerformanceObserver((r=>{Promise.resolve().then((()=>{n(r.getEntries())}))}));return t.observe({type:e,buffered:!0,...i}),t}}catch{}},Z=e=>{let n=!1;return()=>{n||(e(),n=!0)}},b=-1,ye=new Set,ae=()=>document.visibilityState!=="hidden"||document.prerendering?1/0:0,j=e=>{if(document.visibilityState==="hidden"){if(e.type==="visibilitychange")for(let n of ye)n();isFinite(b)||(b=e.type==="visibilitychange"?e.timeStamp:0,removeEventListener("prerenderingchange",j,!0))}},O=()=>{if(b<0){let e=I();b=(document.prerendering?void 0:globalThis.performance.getEntriesByType("visibility-state").filter((i=>i.name==="hidden"&&i.startTime>e))[0]?.startTime)??ae(),addEventListener("visibilitychange",j,!0),addEventListener("prerenderingchange",j,!0),T((()=>{setTimeout((()=>{b=ae()}))}))}return{get firstHiddenTime(){return b},onHidden(e){ye.add(e)}}},q=e=>{document.prerendering?addEventListener("prerenderingchange",(()=>e()),!0):e()},ce=[1800,3e3],Q=(e,n={})=>{q((()=>{let i=O(),t,r=w("FCP"),o=R("paint",(s=>{for(let a of s)a.name==="first-contentful-paint"&&(o.disconnect(),a.startTime<i.firstHiddenTime&&(r.value=Math.max(a.startTime-I(),0),r.entries.push(a),t(!0)))}));o&&(t=y(e,r,ce,n.reportAllChanges),T((s=>{r=w("FCP"),t=y(e,r,ce,n.reportAllChanges),J((()=>{r.value=performance.now()-s.timeStamp,t(!0)}))})))}))},de=[.1,.25],we=(e,n={})=>{let i=O();Q(Z((()=>{let t,r=w("CLS",0),o=Y(n,W),s=l=>{for(let g of l)o.h(g);o.i>r.value&&(r.value=o.i,r.entries=o.o,t())},a=R("layout-shift",s);a&&(t=y(e,r,de,n.reportAllChanges),i.onHidden((()=>{s(a.takeRecords()),t(!0)})),T((()=>{o.i=0,r=w("CLS",0),t=y(e,r,de,n.reportAllChanges),J((()=>t()))})),setTimeout(t))})))},he=0,H=1/0,D=0,Xe=e=>{for(let n of e)n.interactionId&&(H=Math.min(H,n.interactionId),D=Math.max(D,n.interactionId),he=D?(D-H)/7+1:0)},X,le=()=>X?he:performance.interactionCount??0,${'$'}e=()=>{"interactionCount"in performance||X||(X=R("event",Xe,{type:"event",buffered:!0,durationThreshold:0}))},ue=0,${'$'}=class{constructor(){h(this,"u",[]);h(this,"l",new Map);h(this,"m");h(this,"p")}v(){ue=le(),this.u.length=0,this.l.clear()}L(){let n=Math.min(this.u.length-1,Math.floor((le()-ue)/50));return this.u[n]}h(n){if(this.m?.(n),!n.interactionId&&n.entryType!=="first-input")return;let i=this.u.at(-1),t=this.l.get(n.interactionId);if(t||this.u.length<10||n.duration>i.P){if(t?n.duration>t.P?(t.entries=[n],t.P=n.duration):n.duration===t.P&&n.startTime===t.entries[0].startTime&&t.entries.push(n):(t={id:n.interactionId,entries:[n],P:n.duration},this.l.set(t.id,t),this.u.push(t)),this.u.sort(((r,o)=>o.P-r.P)),this.u.length>10){let r=this.u.splice(10);for(let o of r)this.l.delete(o.id)}this.p?.(t)}}},ve=e=>{let n=globalThis.requestIdleCallback||setTimeout;document.visibilityState==="hidden"?e():(e=Z(e),addEventListener("visibilitychange",e,{once:!0,capture:!0}),n((()=>{e(),removeEventListener("visibilitychange",e,{capture:!0})})))},ge=[200,500],Se=(e,n={})=>{if(!globalThis.PerformanceEventTiming||!("interactionId"in PerformanceEventTiming.prototype))return;let i=O();q((()=>{${'$'}e();let t,r=w("INP"),o=Y(n,${'$'}),s=l=>{ve((()=>{for(let f of l)o.h(f);let g=o.L();g&&g.P!==r.value&&(r.value=g.P,r.entries=g.entries,t())}))},a=R("event",s,{durationThreshold:n.durationThreshold??40});t=y(e,r,ge,n.reportAllChanges),a&&(a.observe({type:"first-input",buffered:!0}),i.onHidden((()=>{s(a.takeRecords()),t(!0)})),T((()=>{o.v(),r=w("INP"),t=y(e,r,ge,n.reportAllChanges)})))}))},z=class{constructor(){h(this,"m")}h(n){this.m?.(n)}},me=[2500,4e3],be=(e,n={})=>{q((()=>{let i=O(),t,r=w("LCP"),o=Y(n,z),s=l=>{n.reportAllChanges||(l=l.slice(-1));for(let g of l)o.h(g),g.startTime<i.firstHiddenTime&&(r.value=Math.max(g.startTime-I(),0),r.entries=[g],t())},a=R("largest-contentful-paint",s);if(a){t=y(e,r,me,n.reportAllChanges);let l=Z((()=>{s(a.takeRecords()),a.disconnect(),t(!0)})),g=f=>{f.isTrusted&&(ve(l),removeEventListener(f.type,g,{capture:!0}))};for(let f of["keydown","click","visibilitychange"])addEventListener(f,g,{capture:!0});T((f=>{r=w("LCP"),t=y(e,r,me,n.reportAllChanges),J((()=>{r.value=performance.now()-f.timeStamp,t(!0)}))}))}}))},fe=[800,1800],G=e=>{document.prerendering?q((()=>G(e))):document.readyState!=="complete"?addEventListener("load",(()=>G(e)),!0):setTimeout(e)},Te=(e,n={})=>{let i=w("TTFB"),t=y(e,i,fe,n.reportAllChanges);G((()=>{let r=K();r&&(i.value=Math.max(r.responseStart-I(),0),i.entries=[r],t(!0),T((()=>{i=w("TTFB",0),t=y(e,i,fe,n.reportAllChanges),t(!0)})))}))};var v=null,P=0,ze=()=>typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let n=Math.random()*16|0;return(e==="x"?n:n&3|8).toString(16)}),_e=()=>v,_=(e,n="navigation")=>{c(()=>{v&&B("navigation"),v=ze(),n==="initial"?P=Math.round(performance.timeOrigin):P=Date.now();let i=d({type:"pageView",action:"start",spanId:v,url:e,reason:n,timestamp:P});u(i)})},B=e=>{c(()=>{if(!v)return;let n=Date.now(),i=n-P,t=d({type:"pageView",action:"end",spanId:v,url:window.location.href,reason:e,durationMs:i,timestamp:n});u(t),v=null,P=0})},x=(e,n)=>{c(()=>{let i=d({type:"lifecycle",event:e,performanceTime:performance.now(),...n});u(i)})},ke=()=>{c(()=>{_(window.location.href,"initial"),document.readyState==="loading"?document.addEventListener("DOMContentLoaded",m(()=>{x("DOMContentLoaded")})):x("DOMContentLoaded"),document.readyState!=="complete"?window.addEventListener("load",m(()=>{x("load")})):x("load"),document.addEventListener("visibilitychange",m(()=>{x("visibilitychange",{visibilityState:document.visibilityState}),document.visibilityState==="hidden"?B("hidden"):document.visibilityState==="visible"&&!v&&_(window.location.href,"navigation")})),window.addEventListener("pagehide",m(()=>{B("unload")})),window.addEventListener("beforeunload",m(()=>{B("unload")}))})};var Me=()=>{c(()=>{let e=m(n=>{let i=_e(),t=d({type:"webVital",metric:n,...i&&{parentSpanId:i}});u(t)});be(e),we(e),Se(e),Q(e),Te(e)})};var Ge=0,te=()=>`req_${'$'}{Date.now()}_${'$'}{++Ge}`,k=new Map,M=new Map,C=new Map,E=5e3,U=e=>{if(k.set(e,Date.now()),k.size>100){let n=Date.now();for(let[i,t]of k.entries())n-t>E&&k.delete(i)}},Je=(e,n)=>{let i=k.get(e);if(i===void 0)return!1;let t=performance.timeOrigin+n;return Math.abs(t-i)<E?(k.delete(e),!0):!1},Ke=e=>{if(M.set(e,Date.now()),M.size>100){let n=Date.now();for(let[i,t]of M.entries())n-t>E&&M.delete(i)}},Ce=e=>{let n=M.get(e);return n===void 0?!1:Date.now()-n<E?!0:(M.delete(e),!1)},Ee=(e,n,i)=>{if(C.set(e,{timestamp:Date.now(),resourceType:n,tagName:i}),C.size>100){let t=Date.now();for(let[r,o]of C.entries())t-o.timestamp>E&&C.delete(r)}},Ye=e=>{let n=C.get(e);return n&&Date.now()-n.timestamp<E?(C.delete(e),{failed:!0,resourceType:n.resourceType,tagName:n.tagName}):{failed:!1}},ee=e=>c(()=>typeof performance>"u"||!performance.getEntriesByType?void 0:performance.getEntriesByType("resource").filter(t=>t.name===e).pop()),Ze=()=>{c(()=>{let e=window.fetch;e&&(window.fetch=async(n,i)=>{let t=te(),r=performance.now(),{url:o,method:s}=c(()=>{let a,l;return n instanceof Request?(a=n.url,l=n.method):(a=n.toString(),l=i?.method??"GET"),{url:a,method:l}})??{url:"",method:"GET"};try{let a=await e.call(window,n,i);return c(()=>{let l=performance.now();U(o);let g=d({type:"networkRequest",requestId:t,method:s.toUpperCase(),url:o,statusCode:a.status,durationMs:Math.round(l-r),success:a.ok,requestType:"fetch",timing:ee(o)});u(g)}),a}catch(a){throw c(()=>{let l=performance.now();U(o);let g=d({type:"networkRequest",requestId:t,method:s.toUpperCase(),url:o,statusCode:0,durationMs:Math.round(l-r),success:!1,error:a instanceof Error?a.message:String(a),requestType:"fetch",timing:ee(o)});u(g)}),a}})})},Qe=()=>{c(()=>{let e=XMLHttpRequest.prototype.open,n=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.open=function(i,t,r=!0,o,s){c(()=>{this._bitdrift={method:i.toUpperCase(),url:t.toString(),requestId:te()}}),e.call(this,i,t,r,o,s)},XMLHttpRequest.prototype.send=function(i){let t=this,r=t._bitdrift;if(!r){n.call(this,i);return}let o=performance.now(),s=m(()=>{let l=performance.now();U(r.url);let g=d({type:"networkRequest",requestId:r.requestId,method:r.method,url:r.url,statusCode:t.status,durationMs:Math.round(l-o),success:t.status>=200&&t.status<400,requestType:"xmlhttprequest",timing:ee(r.url)});u(g)}),a=m(()=>{let l=performance.now();U(r.url);let g=d({type:"networkRequest",requestId:r.requestId,method:r.method,url:r.url,statusCode:0,durationMs:Math.round(l-o),success:!1,error:"Network error",requestType:"xmlhttprequest"});u(g)});t.addEventListener("load",s),t.addEventListener("error",a),t.addEventListener("abort",a),t.addEventListener("timeout",a),n.call(this,i)}})},et=()=>{if(!(typeof PerformanceObserver>"u"))try{new PerformanceObserver(m(n=>{let i=n.getEntries();queueMicrotask(m(()=>{for(let t of i)c(()=>{if(Je(t.name,t.responseEnd)||t.name.startsWith("data:")||t.name.startsWith("blob:"))return;let r=Math.round(t.responseEnd-t.startTime),o=t.responseStatus??0,s=o===0?Ye(t.name):{failed:!1},a=o>0?o>=200&&o<400:!s.failed,l=d({type:"networkRequest",requestId:te(),method:"GET",url:t.name,statusCode:o,durationMs:r,success:a,requestType:t.initiatorType,timing:t});Ke(t.name),u(l)})}))})).observe({type:"resource",buffered:!1})}catch{}},Le=()=>{Ze(),Qe(),et()};var S="",Ie=()=>{c(()=>{S=window.location.href;let e=history.pushState;history.pushState=function(i,t,r){e.call(this,i,t,r),c(()=>{let o=S,s=window.location.href;o!==s&&(S=s,ne(o,s,"pushState"),_(s,"navigation"))})};let n=history.replaceState;history.replaceState=function(i,t,r){n.call(this,i,t,r),c(()=>{let o=S,s=window.location.href;o!==s&&(S=s,ne(o,s,"replaceState"),_(s,"navigation"))})},window.addEventListener("popstate",m(()=>{let i=S,t=window.location.href;i!==t&&(S=t,ne(i,t,"popstate"),_(t,"navigation"))}))})},ne=(e,n,i)=>{let t=d({type:"navigation",fromUrl:e,toUrl:n,method:i});u(t)};var Re=()=>{if(!(typeof PerformanceObserver>"u"))try{new PerformanceObserver(m(n=>{for(let i of n.getEntries())c(()=>{let r=i.attribution?.[0],o=d({type:"longTask",durationMs:i.duration,startTime:i.startTime,attribution:r});u(o)})})).observe({type:"longtask",buffered:!0})}catch{}};var tt=500,xe=()=>{c(()=>{window.addEventListener("error",m(e=>{if(e instanceof ErrorEvent)return;let n=e.target;if(!n)return;let i=n.tagName?.toLowerCase();if(!i||!["img","script","link","video","audio","source","iframe"].includes(i))return;let r=n.src||n.href||"";if(!r)return;let o=nt(i,n);Ee(r,o,i),setTimeout(m(()=>{if(Ce(r))return;let s=d({type:"resourceError",resourceType:o,url:r,tagName:i});u(s)}),tt)}),!0)})},nt=(e,n)=>{switch(e){case"img":return"image";case"script":return"script";case"link":{let i=n.rel;return i==="stylesheet"?"stylesheet":i==="icon"||i==="shortcut icon"?"icon":"link"}case"video":return"video";case"audio":return"audio";case"source":return"media-source";case"iframe":return"iframe";default:return e}};var it=["log","warn","error","info","debug"],Ae=()=>{c(()=>{for(let e of it)N.console[e]=N.console[e]??console[e],console[e]=(...n)=>{c(()=>N.console[e]?.apply(console,n)),c(()=>{if(oe(n[0]))return;let i=Pe(n[0]),t=n.length>1?n.slice(1).map(Pe).filter(Boolean):void 0,r=d({type:"console",level:e,message:i,args:t});u(r)})}})},Pe=e=>{if(e===null)return"null";if(e===void 0)return"undefined";if(typeof e=="string")return e;if(typeof e=="number"||typeof e=="boolean")return String(e);if(e instanceof Error)return`${'$'}{e.name}: ${'$'}{e.message}`;try{return JSON.stringify(e,null,0)}catch{return String(e)}};var rt=new Set(["a","button","input","select","textarea","label","summary"]),st=3,De=1e3,ot=100,at=500,A=[],L=null,p=null,Ne=()=>{if(L!==null&&(clearTimeout(L),L=null),p){let e=p.clicks[p.clicks.length-1].timestamp-p.clicks[0].timestamp;qe(p.element,"rageClick",!1,p.clicks.length,e),p=null,A=[]}},Oe=()=>{c(()=>{document.addEventListener("pointerdown",m(dt),!0)})},ct=e=>c(()=>{let n=e;for(;n;){let i=n.tagName.toLowerCase();if(rt.has(i))return!0;let t=n.getAttribute("role");if(t==="button"||t==="link"||t==="menuitem"||n.hasAttribute("onclick")||n.hasAttribute("tabindex")||window.getComputedStyle(n).cursor==="pointer")return!0;n=n.parentElement}return!1})??!1,dt=e=>{let n=e.target;if(!n)return;let i=ct(n),t=Date.now();if(i)qe(n,"click",!0);else{let r={x:e.clientX,y:e.clientY,timestamp:t,element:n};A.push(r),A=A.filter(s=>t-s.timestamp<De);let o=A.filter(s=>Math.sqrt((s.x-e.clientX)**2+(s.y-e.clientY)**2)<ot);o.length>=st&&(p&&p.element===n?p.clicks=o:(p&&Ne(),p={element:n,clicks:o}),L!==null&&clearTimeout(L),L=setTimeout(()=>{Ne()},at))}},qe=(e,n,i,t,r)=>{c(()=>{let o=e.tagName.toLowerCase(),s=e.id||void 0,a=e.className?typeof e.className=="string"?e.className:e.className.toString():void 0,l=e.hasAttribute("data-redacted"),g;if(l)g="<redacted>";else if(e.textContent){let F=e.textContent.trim().replace(/\s+/g," ");g=F.length>50?`${'$'}{F.slice(0,50)}...`:F||void 0}let f=d({type:"userInteraction",interactionType:n,tagName:o,elementId:s,className:a?.slice(0,100),textContent:g,isClickable:i,clickCount:n==="rageClick"?t:void 0,timeWindowMs:n==="rageClick"?De:void 0,duration:n==="rageClick"?r:void 0});u(f)})};var Be=()=>{c(()=>{window.addEventListener("error",m(e=>{if(e.target&&e.target!==window)return;let n=e.error,i;n instanceof Error&&(i=n.stack);let t=d({type:"error",name:n?.name??"Error",message:e.message||"Unknown error",stack:i,filename:e.filename||void 0,lineno:e.lineno||void 0,colno:e.colno||void 0});u(t)}))})},Ue=()=>{c(()=>{window.addEventListener("unhandledrejection",m(e=>{let n="Unknown rejection reason",i;if(e.reason instanceof Error)n=e.reason.message,i=e.reason.stack;else if(typeof e.reason=="string")n=e.reason;else if(e.reason!==null&&e.reason!==void 0)try{n=JSON.stringify(e.reason)}catch{n=String(e.reason)}let t=d({type:"promiseRejection",reason:n,stack:i});u(t)}))})};var lt=e=>{c(()=>{window.__bitdriftBridgeInitialized||(window.__bitdriftBridgeInitialized=!0,window.bitdrift=window.bitdrift||{},window.bitdrift.config=e,se(),u(d({type:"bridgeReady",url:window.location.href,instrumentationConfig:window.bitdrift.config})),window.bitdrift.config?.capturePageViews&&(c(()=>ke()),u(d({type:"internalAutoInstrumentation",event:"capturePageViews"}))),window.bitdrift.config?.captureNetworkRequests&&(c(()=>Le()),u(d({type:"internalAutoInstrumentation",event:"captureNetworkRequests"}))),window.bitdrift.config?.captureNavigationEvents&&(c(()=>Ie()),u(d({type:"internalAutoInstrumentation",event:"captureNavigationEvents"}))),window.bitdrift.config?.captureWebVitals&&(c(()=>Me()),u(d({type:"internalAutoInstrumentation",event:"captureWebVitals"}))),window.bitdrift.config?.captureLongTasks&&(c(()=>Re()),u(d({type:"internalAutoInstrumentation",event:"captureLongTasks"}))),window.bitdrift.config?.captureConsoleLogs&&(c(()=>Ae()),u(d({type:"internalAutoInstrumentation",event:"captureConsoleLogs"}))),window.bitdrift.config?.captureUserInteractions&&(c(()=>Oe()),u(d({type:"internalAutoInstrumentation",event:"captureUserInteractions"}))),window.bitdrift.config?.captureErrors&&(c(()=>xe()),c(()=>Ue()),c(()=>Be()),u(d({type:"internalAutoInstrumentation",event:"captureErrors"}))))})};lt("""

    private const val SCRIPT_SUFFIX: String = """);})();
})();

"""

    /**
     * Generates the JavaScript bundle with the provided configuration.
     *
     * @param config The WebView instrumentation configuration
     * @return The complete JavaScript bundle with config injected
     */
    fun getScript(config: WebViewConfiguration): String = SCRIPT_PREFIX + config.toJson() + SCRIPT_SUFFIX
}
