// capture-sdk - bitdrift's client SDK
// Copyright Bitdrift, Inc. All rights reserved.
//
// Use of this source code is governed by a source available license that can be found in the
// LICENSE file or at:
// https://polyformproject.org/wp-content/uploads/2020/06/PolyForm-Shield-1.0.0.txt

// AUTO-GENERATED FILE - DO NOT EDIT
// Generated by: npm run generate
// Source: platform/webview/src/

@file:Suppress("MaxLineLength")

package io.bitdrift.capture.webview

/**
 * Contains the bundled JavaScript SDK for WebView instrumentation.
 * This script is injected into WebViews to capture performance metrics,
 * network events, and user interactions.
 */
internal object WebViewBridgeScript {
    private const val SCRIPT_PREFIX: String = """
(function() {
"use strict";var BitdriftWebView=(()=>{var Fe=Object.defineProperty;var He=(e,t,i)=>t in e?Fe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:i}):e[t]=i;var v=(e,t,i)=>He(e,typeof t!="symbol"?t+"":t,i);var a=e=>{try{return e()}catch{return}};var m=e=>(...t)=>{try{return e(...t)}catch{return}};var N={console:{log:console.log,warn:console.warn,error:console.error,info:console.info,debug:console.debug}},Ve=e=>({_source:"webview",_timestamp:(e??Date.now()).toString()});var Xe=()=>a(()=>window.webkit?.messageHandlers?.BitdriftLogger?"ios":window.BitdriftLogger?"android":"unknown")??"unknown",ie=e=>{a(()=>{let t=Xe(),i=JSON.stringify(e);switch(t){case"ios":window.webkit?.messageHandlers?.BitdriftLogger?.postMessage(e);break;case"android":window.BitdriftLogger?.log(i);break;case"unknown":typeof console<"u"&&console.debug("[Bitdrift WebView]",e);break}})},oe=()=>{window.bitdrift?.log||(window.bitdrift={config:window.bitdrift?.config,log:(...e)=>{if(e.length!==1&&e.length!==3)throw new Error("Invalid arguments to bitdrift.log. Expected 1 or 3 arguments.");let t;if(e.length===1)t=e[0];else{let[i,n,r]=e;t=d({type:"customLog",level:i,message:n,fields:r})}ie(t)}})},l=e=>{window.bitdrift?window.bitdrift.log?.(e):ie(e)},d=({type:e,timestamp:t,fields:i,...n})=>{let r=t??Date.now(),o=Ve(r);return{tag:"bitdrift-webview-sdk",v:1,timestamp:r,type:e,...n,fields:i?{...o,...i}:o}},se=e=>typeof e=="object"&&e!==null&&"type"in e&&typeof e.type=="string"&&"v"in e&&typeof e.v=="number"&&"tag"in e&&e.tag==="bitdrift-webview-sdk";var pe=-1,T=e=>{addEventListener("pageshow",(t=>{t.persisted&&(pe=t.timeStamp,e(t))}),!0)},w=(e,t,i,n)=>{let r,o;return s=>{t.value>=0&&(s||n)&&(o=t.value-(r??0),(o||r===void 0)&&(r=t.value,t.delta=o,t.rating=((c,u)=>c>u[1]?"poor":c>u[0]?"needs-improvement":"good")(t.value,i),e(t)))}},J=e=>{requestAnimationFrame((()=>requestAnimationFrame((()=>e()))))},K=()=>{let e=performance.getEntriesByType("navigation")[0];if(e&&e.responseStart>0&&e.responseStart<performance.now())return e},R=()=>K()?.activationStart??0,h=(e,t=-1)=>{let i=K(),n="navigate";return pe>=0?n="back-forward-cache":i&&(document.prerendering||R()>0?n="prerender":document.wasDiscarded?n="restore":i.type&&(n=i.type.replace(/_/g,"-"))),{name:e,value:t,rating:"good",delta:0,entries:[],id:`v5-${'$'}{Date.now()}-${'$'}{Math.floor(8999999999999*Math.random())+1e12}`,navigationType:n}},H=new WeakMap;function Y(e,t){return H.get(e)||H.set(e,new t),H.get(e)}var X=class{constructor(){v(this,"t");v(this,"i",0);v(this,"o",[])}h(t){if(t.hadRecentInput)return;let i=this.o[0],n=this.o.at(-1);this.i&&i&&n&&t.startTime-n.startTime<1e3&&t.startTime-i.startTime<5e3?(this.i+=t.value,this.o.push(t)):(this.i=t.value,this.o=[t]),this.t?.(t)}},x=(e,t,i={})=>{try{if(PerformanceObserver.supportedEntryTypes.includes(e)){let n=new PerformanceObserver((r=>{Promise.resolve().then((()=>{t(r.getEntries())}))}));return n.observe({type:e,buffered:!0,...i}),n}}catch{}},Z=e=>{let t=!1;return()=>{t||(e(),t=!0)}},b=-1,we=new Set,ae=()=>document.visibilityState!=="hidden"||document.prerendering?1/0:0,${'$'}=e=>{if(document.visibilityState==="hidden"){if(e.type==="visibilitychange")for(let t of we)t();isFinite(b)||(b=e.type==="visibilitychange"?e.timeStamp:0,removeEventListener("prerenderingchange",${'$'},!0))}},B=()=>{if(b<0){let e=R();b=(document.prerendering?void 0:globalThis.performance.getEntriesByType("visibility-state").filter((i=>i.name==="hidden"&&i.startTime>e))[0]?.startTime)??ae(),addEventListener("visibilitychange",${'$'},!0),addEventListener("prerenderingchange",${'$'},!0),T((()=>{setTimeout((()=>{b=ae()}))}))}return{get firstHiddenTime(){return b},onHidden(e){we.add(e)}}},D=e=>{document.prerendering?addEventListener("prerenderingchange",(()=>e()),!0):e()},ce=[1800,3e3],Q=(e,t={})=>{D((()=>{let i=B(),n,r=h("FCP"),o=x("paint",(s=>{for(let c of s)c.name==="first-contentful-paint"&&(o.disconnect(),c.startTime<i.firstHiddenTime&&(r.value=Math.max(c.startTime-R(),0),r.entries.push(c),n(!0)))}));o&&(n=w(e,r,ce,t.reportAllChanges),T((s=>{r=h("FCP"),n=w(e,r,ce,t.reportAllChanges),J((()=>{r.value=performance.now()-s.timeStamp,n(!0)}))})))}))},de=[.1,.25],he=(e,t={})=>{let i=B();Q(Z((()=>{let n,r=h("CLS",0),o=Y(t,X),s=u=>{for(let f of u)o.h(f);o.i>r.value&&(r.value=o.i,r.entries=o.o,n())},c=x("layout-shift",s);c&&(n=w(e,r,de,t.reportAllChanges),i.onHidden((()=>{s(c.takeRecords()),n(!0)})),T((()=>{o.i=0,r=h("CLS",0),n=w(e,r,de,t.reportAllChanges),J((()=>n()))})),setTimeout(n))})))},ye=0,V=1/0,q=0,${'$'}e=e=>{for(let t of e)t.interactionId&&(V=Math.min(V,t.interactionId),q=Math.max(q,t.interactionId),ye=q?(q-V)/7+1:0)},W,le=()=>W?ye:performance.interactionCount??0,We=()=>{"interactionCount"in performance||W||(W=x("event",${'$'}e,{type:"event",buffered:!0,durationThreshold:0}))},ue=0,z=class{constructor(){v(this,"u",[]);v(this,"l",new Map);v(this,"m");v(this,"p")}v(){ue=le(),this.u.length=0,this.l.clear()}L(){let t=Math.min(this.u.length-1,Math.floor((le()-ue)/50));return this.u[t]}h(t){if(this.m?.(t),!t.interactionId&&t.entryType!=="first-input")return;let i=this.u.at(-1),n=this.l.get(t.interactionId);if(n||this.u.length<10||t.duration>i.P){if(n?t.duration>n.P?(n.entries=[t],n.P=t.duration):t.duration===n.P&&t.startTime===n.entries[0].startTime&&n.entries.push(t):(n={id:t.interactionId,entries:[t],P:t.duration},this.l.set(n.id,n),this.u.push(n)),this.u.sort(((r,o)=>o.P-r.P)),this.u.length>10){let r=this.u.splice(10);for(let o of r)this.l.delete(o.id)}this.p?.(n)}}},ve=e=>{let t=globalThis.requestIdleCallback||setTimeout;document.visibilityState==="hidden"?e():(e=Z(e),addEventListener("visibilitychange",e,{once:!0,capture:!0}),t((()=>{e(),removeEventListener("visibilitychange",e,{capture:!0})})))},fe=[200,500],_e=(e,t={})=>{if(!globalThis.PerformanceEventTiming||!("interactionId"in PerformanceEventTiming.prototype))return;let i=B();D((()=>{We();let n,r=h("INP"),o=Y(t,z),s=u=>{ve((()=>{for(let g of u)o.h(g);let f=o.L();f&&f.P!==r.value&&(r.value=f.P,r.entries=f.entries,n())}))},c=x("event",s,{durationThreshold:t.durationThreshold??40});n=w(e,r,fe,t.reportAllChanges),c&&(c.observe({type:"first-input",buffered:!0}),i.onHidden((()=>{s(c.takeRecords()),n(!0)})),T((()=>{o.v(),r=h("INP"),n=w(e,r,fe,t.reportAllChanges)})))}))},G=class{constructor(){v(this,"m")}h(t){this.m?.(t)}},me=[2500,4e3],be=(e,t={})=>{D((()=>{let i=B(),n,r=h("LCP"),o=Y(t,G),s=u=>{t.reportAllChanges||(u=u.slice(-1));for(let f of u)o.h(f),f.startTime<i.firstHiddenTime&&(r.value=Math.max(f.startTime-R(),0),r.entries=[f],n())},c=x("largest-contentful-paint",s);if(c){n=w(e,r,me,t.reportAllChanges);let u=Z((()=>{s(c.takeRecords()),c.disconnect(),n(!0)})),f=g=>{g.isTrusted&&(ve(u),removeEventListener(g.type,f,{capture:!0}))};for(let g of["keydown","click","visibilitychange"])addEventListener(g,f,{capture:!0});T((g=>{r=h("LCP"),n=w(e,r,me,t.reportAllChanges),J((()=>{r.value=performance.now()-g.timeStamp,n(!0)}))}))}}))},ge=[800,1800],j=e=>{document.prerendering?D((()=>j(e))):document.readyState!=="complete"?addEventListener("load",(()=>j(e)),!0):setTimeout(e)},Te=(e,t={})=>{let i=h("TTFB"),n=w(e,i,ge,t.reportAllChanges);j((()=>{let r=K();r&&(i.value=Math.max(r.responseStart-R(),0),i.entries=[r],n(!0),T((()=>{i=h("TTFB",0),n=w(e,i,ge,t.reportAllChanges),n(!0)})))}))};var y=null,P=0,ze=()=>typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)}),Se=()=>y,S=(e,t="navigation")=>{a(()=>{y&&O("navigation"),y=ze(),t==="initial"?P=Math.round(performance.timeOrigin):P=Date.now();let i=d({type:"pageView",action:"start",spanId:y,url:e,reason:t,timestamp:P,fields:{_span_id:y,_url:e,_reason:t}});l(i)})},O=e=>{a(()=>{if(!y)return;let t=Date.now(),i=t-P,n=d({type:"pageView",action:"end",spanId:y,url:window.location.href,reason:e,durationMs:i,timestamp:t,fields:{_span_id:y,_url:window.location.href,_reason:e,_duration_ms:i.toString()}});l(n),y=null,P=0})},I=(e,t)=>{a(()=>{let i={_event:e,_performance_time:performance.now().toString()};t?.visibilityState&&(i._visibility_state=t.visibilityState);let n=d({type:"lifecycle",event:e,performanceTime:performance.now(),...t,fields:i});l(n)})},ke=()=>{a(()=>{S(window.location.href,"initial"),document.readyState==="loading"?document.addEventListener("DOMContentLoaded",m(()=>{I("DOMContentLoaded")})):I("DOMContentLoaded"),document.readyState!=="complete"?window.addEventListener("load",m(()=>{I("load")})):I("load"),document.addEventListener("visibilitychange",m(()=>{I("visibilitychange",{visibilityState:document.visibilityState}),document.visibilityState==="hidden"?O("hidden"):document.visibilityState==="visible"&&!y&&S(window.location.href,"navigation")})),window.addEventListener("pagehide",m(()=>{O("unload")})),window.addEventListener("beforeunload",m(()=>{O("unload")}))})};var Ee=()=>{a(()=>{let e=m(t=>{let i=Se(),n={_metric:t.name,_value:t.value.toString(),_rating:t.rating};t.delta!==void 0&&(n._delta=t.delta.toString()),t.id&&(n._metric_id=t.id),t.navigationType&&(n._navigation_type=t.navigationType),i&&(n._span_parent_id=i);let r=t.entries?.[0];if(r){if(r.startTime!==void 0&&(n._start_time=r.startTime.toString()),r.entryType&&(n._entry_type=r.entryType),"element"in r&&r.element){let s=r.element,c=s.tagName?`${'$'}{s.tagName.toLowerCase()}${'$'}{s.id?"#"+s.id:""}${'$'}{s.className?"."+s.className.split(" ").join("."):""}`:s.toString();n._element=c}"url"in r&&r.url&&(n._url=r.url),"size"in r&&r.size!==void 0&&(n._size=r.size.toString()),"renderTime"in r&&r.renderTime!==void 0&&(n._render_time=r.renderTime.toString()),"loadTime"in r&&r.loadTime!==void 0&&(n._load_time=r.loadTime.toString()),"name"in r&&r.name&&t.name==="FCP"&&(n._paint_type=r.name),"domainLookupStart"in r&&r.domainLookupStart!==void 0&&(n._dns_start=r.domainLookupStart.toString()),"domainLookupEnd"in r&&r.domainLookupEnd!==void 0&&(n._dns_end=r.domainLookupEnd.toString()),"connectStart"in r&&r.connectStart!==void 0&&(n._connect_start=r.connectStart.toString()),"connectEnd"in r&&r.connectEnd!==void 0&&(n._connect_end=r.connectEnd.toString()),"secureConnectionStart"in r&&r.secureConnectionStart!==void 0&&(n._tls_start=r.secureConnectionStart.toString()),"requestStart"in r&&r.requestStart!==void 0&&(n._request_start=r.requestStart.toString()),"responseStart"in r&&r.responseStart!==void 0&&(n._response_start=r.responseStart.toString()),"processingStart"in r&&r.processingStart!==void 0&&(n._processing_start=r.processingStart.toString()),"processingEnd"in r&&r.processingEnd!==void 0&&(n._processing_end=r.processingEnd.toString()),"duration"in r&&r.duration!==void 0&&(n._duration=r.duration.toString()),"interactionId"in r&&r.interactionId!==void 0&&(n._interaction_id=r.interactionId.toString()),"name"in r&&r.name&&t.name==="INP"&&(n._event_type=r.name)}if(t.name==="CLS"&&t.entries&&t.entries.length>0){let s=0,c=0;for(let u of t.entries){let f="value"in u?u.value:0;f>s&&(s=f,c=u.startTime??0)}s>0&&(n._largest_shift_value=s.toString(),n._largest_shift_time=c.toString()),n._shift_count=t.entries.length.toString()}let o=d({type:"webVital",metric:t,...i&&{parentSpanId:i},fields:n});l(o)});be(e),he(e),_e(e),Q(e),Te(e)})};var Ge=0,te=()=>`req_${'$'}{Date.now()}_${'$'}{++Ge}`,k=new Map,E=new Map,C=new Map,M=5e3,U=e=>{if(k.set(e,Date.now()),k.size>100){let t=Date.now();for(let[i,n]of k.entries())t-n>M&&k.delete(i)}},je=(e,t)=>{let i=k.get(e);if(i===void 0)return!1;let n=performance.timeOrigin+t;return Math.abs(n-i)<M?(k.delete(e),!0):!1},Je=e=>{if(E.set(e,Date.now()),E.size>100){let t=Date.now();for(let[i,n]of E.entries())t-n>M&&E.delete(i)}},Ce=e=>{let t=E.get(e);return t===void 0?!1:Date.now()-t<M?!0:(E.delete(e),!1)},Me=(e,t,i)=>{if(C.set(e,{timestamp:Date.now(),resourceType:t,tagName:i}),C.size>100){let n=Date.now();for(let[r,o]of C.entries())n-o.timestamp>M&&C.delete(r)}},Ke=e=>{let t=C.get(e);return t&&Date.now()-t.timestamp<M?(C.delete(e),{failed:!0,resourceType:t.resourceType,tagName:t.tagName}):{failed:!1}},ee=e=>a(()=>typeof performance>"u"||!performance.getEntriesByType?void 0:performance.getEntriesByType("resource").filter(n=>n.name===e).pop()),Ye=()=>{a(()=>{let e=window.fetch;e&&(window.fetch=async(t,i)=>{let n=te(),r=performance.now(),{url:o,method:s}=a(()=>{let c,u;return t instanceof Request?(c=t.url,u=t.method):(c=t.toString(),u=i?.method??"GET"),{url:c,method:u}})??{url:"",method:"GET"};try{let c=await e.call(window,t,i);return a(()=>{let u=performance.now();U(o);let f=d({type:"networkRequest",requestId:n,method:s.toUpperCase(),url:o,statusCode:c.status,durationMs:Math.round(u-r),success:c.ok,requestType:"fetch",timing:ee(o)});l(f)}),c}catch(c){throw a(()=>{let u=performance.now();U(o);let f=d({type:"networkRequest",requestId:n,method:s.toUpperCase(),url:o,statusCode:0,durationMs:Math.round(u-r),success:!1,error:c instanceof Error?c.message:String(c),requestType:"fetch",timing:ee(o)});l(f)}),c}})})},Ze=()=>{a(()=>{let e=XMLHttpRequest.prototype.open,t=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.open=function(i,n,r=!0,o,s){a(()=>{this._bitdrift={method:i.toUpperCase(),url:n.toString(),requestId:te()}}),e.call(this,i,n,r,o,s)},XMLHttpRequest.prototype.send=function(i){let n=this,r=n._bitdrift;if(!r){t.call(this,i);return}let o=performance.now(),s=m(()=>{let u=performance.now();U(r.url);let f=d({type:"networkRequest",requestId:r.requestId,method:r.method,url:r.url,statusCode:n.status,durationMs:Math.round(u-o),success:n.status>=200&&n.status<400,requestType:"xmlhttprequest",timing:ee(r.url)});l(f)}),c=m(()=>{let u=performance.now();U(r.url);let f=d({type:"networkRequest",requestId:r.requestId,method:r.method,url:r.url,statusCode:0,durationMs:Math.round(u-o),success:!1,error:"Network error",requestType:"xmlhttprequest"});l(f)});n.addEventListener("load",s),n.addEventListener("error",c),n.addEventListener("abort",c),n.addEventListener("timeout",c),t.call(this,i)}})},Qe=()=>{if(!(typeof PerformanceObserver>"u"))try{new PerformanceObserver(m(t=>{let i=t.getEntries();queueMicrotask(m(()=>{for(let n of i)a(()=>{if(je(n.name,n.responseEnd)||n.name.startsWith("data:")||n.name.startsWith("blob:"))return;let r=Math.round(n.responseEnd-n.startTime),o=n.responseStatus??0,s=o===0?Ke(n.name):{failed:!1},c=o>0?o>=200&&o<400:!s.failed,u=d({type:"networkRequest",requestId:te(),method:"GET",url:n.name,statusCode:o,durationMs:r,success:c,requestType:n.initiatorType,timing:n});Je(n.name),l(u)})}))})).observe({type:"resource",buffered:!1})}catch{}},Le=()=>{Ye(),Ze(),Qe()};var _="",Re=()=>{a(()=>{_=window.location.href;let e=history.pushState;history.pushState=function(i,n,r){e.call(this,i,n,r),a(()=>{let o=_,s=window.location.href;o!==s&&(_=s,ne(o,s,"pushState"),S(s,"navigation"))})};let t=history.replaceState;history.replaceState=function(i,n,r){t.call(this,i,n,r),a(()=>{let o=_,s=window.location.href;o!==s&&(_=s,ne(o,s,"replaceState"),S(s,"navigation"))})},window.addEventListener("popstate",m(()=>{let i=_,n=window.location.href;i!==n&&(_=n,ne(i,n,"popstate"),S(n,"navigation"))}))})},ne=(e,t,i)=>{let n=d({type:"navigation",fromUrl:e,toUrl:t,method:i,fields:{_from_url:e,_to_url:t,_method:i}});l(n)};var xe=()=>{if(!(typeof PerformanceObserver>"u"))try{new PerformanceObserver(m(t=>{for(let i of t.getEntries())a(()=>{let r=i.attribution?.[0],o={_duration_ms:i.duration.toString(),_start_time:i.startTime.toString()};r&&(r.name&&(o._attribution_name=r.name),r.containerType&&(o._container_type=r.containerType),r.containerSrc&&(o._container_src=r.containerSrc),r.containerId&&(o._container_id=r.containerId),r.containerName&&(o._container_name=r.containerName));let s=d({type:"longTask",durationMs:i.duration,startTime:i.startTime,attribution:r,fields:o});l(s)})})).observe({type:"longtask",buffered:!0})}catch{}};var et=500,Ie=()=>{a(()=>{window.addEventListener("error",m(e=>{if(e instanceof ErrorEvent)return;let t=e.target;if(!t)return;let i=t.tagName?.toLowerCase();if(!i||!["img","script","link","video","audio","source","iframe"].includes(i))return;let r=t.src||t.href||"";if(!r)return;let o=tt(i,t);Me(r,o,i),setTimeout(m(()=>{if(Ce(r))return;let s=d({type:"resourceError",resourceType:o,url:r,tagName:i,fields:{_resource_type:o,_url:r,_tag_name:i}});l(s)}),et)}),!0)})},tt=(e,t)=>{switch(e){case"img":return"image";case"script":return"script";case"link":{let i=t.rel;return i==="stylesheet"?"stylesheet":i==="icon"||i==="shortcut icon"?"icon":"link"}case"video":return"video";case"audio":return"audio";case"source":return"media-source";case"iframe":return"iframe";default:return e}};var nt=["log","warn","error","info","debug"],Ae=()=>{a(()=>{for(let e of nt)N.console[e]=N.console[e]??console[e],console[e]=(...t)=>{a(()=>N.console[e]?.apply(console,t)),a(()=>{if(se(t[0]))return;let i=Pe(t[0]),n=t.length>1?t.slice(1).map(Pe).filter(Boolean):void 0,r=d({type:"console",level:e,message:i,args:n,fields:{_level:e,_message:i,...n&&n.length>0&&{_args:n.slice(0,5).join(", ")}}});l(r)})}})},Pe=e=>{if(e===null)return"null";if(e===void 0)return"undefined";if(typeof e=="string")return e;if(typeof e=="number"||typeof e=="boolean")return String(e);if(e instanceof Error)return`${'$'}{e.name}: ${'$'}{e.message}`;try{return JSON.stringify(e,null,0)}catch{return String(e)}};var rt=new Set(["a","button","input","select","textarea","label","summary"]),it=3,re=1e3,ot=100,st=500,A=[],L=null,p=null,Ne=()=>{if(L!==null&&(clearTimeout(L),L=null),p){let e=p.clicks[p.clicks.length-1].timestamp-p.clicks[0].timestamp;Be(p.element,"rageClick",!1,p.clicks.length,e),p=null,A=[]}},qe=()=>{a(()=>{document.addEventListener("pointerdown",m(ct),!0)})},at=e=>a(()=>{let t=e;for(;t;){let i=t.tagName.toLowerCase();if(rt.has(i))return!0;let n=t.getAttribute("role");if(n==="button"||n==="link"||n==="menuitem"||t.hasAttribute("onclick")||t.hasAttribute("tabindex")||window.getComputedStyle(t).cursor==="pointer")return!0;t=t.parentElement}return!1})??!1,ct=e=>{let t=e.target;if(!t)return;let i=at(t),n=Date.now();if(i)Be(t,"click",!0);else{let r={x:e.clientX,y:e.clientY,timestamp:n,element:t};A.push(r),A=A.filter(s=>n-s.timestamp<re);let o=A.filter(s=>Math.sqrt((s.x-e.clientX)**2+(s.y-e.clientY)**2)<ot);o.length>=it&&(p&&p.element===t?p.clicks=o:(p&&Ne(),p={element:t,clicks:o}),L!==null&&clearTimeout(L),L=setTimeout(()=>{Ne()},st))}},Be=(e,t,i,n,r)=>{a(()=>{let o=e.tagName.toLowerCase(),s=e.id||void 0,c=e.className?typeof e.className=="string"?e.className:e.className.toString():void 0,u=e.hasAttribute("data-redacted"),f;if(u)f="<redacted>";else if(e.textContent){let F=e.textContent.trim().replace(/\s+/g," ");f=F.length>50?`${'$'}{F.slice(0,50)}...`:F||void 0}let g={_interaction_type:t,_tag_name:o,_is_clickable:i.toString()};s&&(g._element_id=s),c&&(g._class_name=c.slice(0,100)),f&&(g._text_content=f),t==="rageClick"&&(n&&(g._click_count=n.toString()),g._time_window_ms=re.toString(),r&&(g._duration=r.toString()));let Ue=d({type:"userInteraction",interactionType:t,tagName:o,elementId:s,className:c?.slice(0,100),textContent:f,isClickable:i,clickCount:t==="rageClick"?n:void 0,timeWindowMs:t==="rageClick"?re:void 0,duration:t==="rageClick"?r:void 0,fields:g});l(Ue)})};var De=()=>{a(()=>{window.addEventListener("error",m(e=>{if(e.target&&e.target!==window)return;let t=e.error,i;t instanceof Error&&(i=t.stack);let n=d({type:"error",name:t?.name??"Error",message:e.message||"Unknown error",stack:i,filename:e.filename||void 0,lineno:e.lineno||void 0,colno:e.colno||void 0,fields:{_name:t?.name??"Error",_message:e.message||"Unknown error",...i&&{_stack:i},...e.filename&&{_filename:e.filename},...e.lineno&&{_lineno:e.lineno.toString()},...e.colno&&{_colno:e.colno.toString()}}});l(n)}))})},Oe=()=>{a(()=>{window.addEventListener("unhandledrejection",m(e=>{let t="Unknown rejection reason",i;if(e.reason instanceof Error)t=e.reason.message,i=e.reason.stack;else if(typeof e.reason=="string")t=e.reason;else if(e.reason!==null&&e.reason!==void 0)try{t=JSON.stringify(e.reason)}catch{t=String(e.reason)}let n=d({type:"promiseRejection",reason:t,stack:i,fields:{_reason:t,...i&&{_stack:i}}});l(n)}))})};var dt=e=>{a(()=>{window.__bitdriftBridgeInitialized||(window.__bitdriftBridgeInitialized=!0,window.bitdrift=window.bitdrift||{},window.bitdrift.config=e,oe(),l(d({type:"bridgeReady",url:window.location.href,instrumentationConfig:window.bitdrift.config,fields:{_url:window.location.href,...window.bitdrift.config&&{_config:JSON.stringify(window.bitdrift.config)}}})),window.bitdrift.config?.capturePageViews&&(a(()=>ke()),l(d({type:"internalAutoInstrumentation",event:"capturePageViews",fields:{_event:"capturePageViews"}}))),window.bitdrift.config?.captureNetworkRequests&&(a(()=>Le()),l(d({type:"internalAutoInstrumentation",event:"captureNetworkRequests",fields:{_event:"captureNetworkRequests"}}))),window.bitdrift.config?.captureNavigationEvents&&(a(()=>Re()),l(d({type:"internalAutoInstrumentation",event:"captureNavigationEvents",fields:{_event:"captureNavigationEvents"}}))),window.bitdrift.config?.captureWebVitals&&(a(()=>Ee()),l(d({type:"internalAutoInstrumentation",event:"captureWebVitals",fields:{_event:"captureWebVitals"}}))),window.bitdrift.config?.captureLongTasks&&(a(()=>xe()),l(d({type:"internalAutoInstrumentation",event:"captureLongTasks",fields:{_event:"captureLongTasks"}}))),window.bitdrift.config?.captureConsoleLogs&&(a(()=>Ae()),l(d({type:"internalAutoInstrumentation",event:"captureConsoleLogs",fields:{_event:"captureConsoleLogs"}}))),window.bitdrift.config?.captureUserInteractions&&(a(()=>qe()),l(d({type:"internalAutoInstrumentation",event:"captureUserInteractions",fields:{_event:"captureUserInteractions"}}))),window.bitdrift.config?.captureErrors&&(a(()=>Ie()),a(()=>Oe()),a(()=>De()),l(d({type:"internalAutoInstrumentation",event:"captureErrors",fields:{_event:"captureErrors"}}))))})};dt("""

    private const val SCRIPT_SUFFIX: String = """);})();
})();

"""

    /**
     * Generates the JavaScript bundle with the provided configuration.
     *
     * @param config The WebView instrumentation configuration
     * @return The complete JavaScript bundle with config injected
     */
    fun getScript(config: WebViewConfiguration): String = SCRIPT_PREFIX + config.toJson() + SCRIPT_SUFFIX
}
