// capture-sdk - bitdrift's client SDK
// Copyright Bitdrift, Inc. All rights reserved.
//
// Use of this source code is governed by a source available license that can be found in the
// LICENSE file or at:
// https://polyformproject.org/wp-content/uploads/2020/06/PolyForm-Shield-1.0.0.txt

// AUTO-GENERATED FILE - DO NOT EDIT
// Generated by: npm run generate
// Source: platform/webview/src/

// swiftlint:disable line_length

import Foundation

/// Contains the bundled JavaScript SDK for WebView instrumentation.
/// This script is injected into WebViews to capture performance metrics,
/// network events, and user interactions.
enum WebViewBridgeScript {
    // The script is minified and contains the web vitals library and instrumentation code
    // swiftlint:disable:next force_unwrapping
    private static let scriptPrefix = """
(function() {
"use strict";var BitdriftWebView=(()=>{var Oe=Object.defineProperty;var He=(e,t,r)=>t in e?Oe(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var y=(e,t,r)=>He(e,typeof t!="symbol"?t+"":t,r);var s=e=>{try{return e()}catch{return}};var f=e=>(...t)=>{try{return e(...t)}catch{return}};var B={console:{log:console.log,warn:console.warn,error:console.error,info:console.info,debug:console.debug}},Fe=()=>s(()=>window.webkit?.messageHandlers?.BitdriftLogger?"ios":window.BitdriftLogger?"android":"unknown")??"unknown",re=e=>{s(()=>{let t=Fe(),r=JSON.stringify(e);switch(t){case"ios":window.webkit?.messageHandlers?.BitdriftLogger?.postMessage(e);break;case"android":window.BitdriftLogger?.log(r);break;case"unknown":typeof console<"u"&&console.debug("[Bitdrift WebView]",e);break}})},ie=()=>{window.bitdrift?.log||(window.bitdrift={config:window.bitdrift?.config,log:(...e)=>{if(e.length!==1&&e.length!==3)throw new Error("Invalid arguments to bitdrift.log. Expected 1 or 3 arguments.");let t;if(e.length===1)t=e[0];else{let[r,n,i]=e;t=d({type:"customLog",level:r,message:n,fields:i})}re(t)}})},l=e=>{window.bitdrift?window.bitdrift.log?.(e):re(e)},d=({type:e,timestamp:t,...r})=>({tag:"bitdrift-webview-sdk",v:1,timestamp:t??Date.now(),type:e,...r}),oe=e=>typeof e=="object"&&e!==null&&"type"in e&&typeof e.type=="string"&&"v"in e&&typeof e.v=="number"&&"tag"in e&&e.tag==="bitdrift-webview-sdk";var ge=-1,M=e=>{addEventListener("pageshow",(t=>{t.persisted&&(ge=t.timeStamp,e(t))}),!0)},h=(e,t,r,n)=>{let i,o;return a=>{t.value>=0&&(a||n)&&(o=t.value-(i??0),(o||i===void 0)&&(i=t.value,t.delta=o,t.rating=((c,u)=>c>u[1]?"poor":c>u[0]?"needs-improvement":"good")(t.value,r),e(t)))}},K=e=>{requestAnimationFrame((()=>requestAnimationFrame((()=>e()))))},Y=()=>{let e=performance.getEntriesByType("navigation")[0];if(e&&e.responseStart>0&&e.responseStart<performance.now())return e},I=()=>Y()?.activationStart??0,w=(e,t=-1)=>{let r=Y(),n="navigate";return ge>=0?n="back-forward-cache":r&&(document.prerendering||I()>0?n="prerender":document.wasDiscarded?n="restore":r.type&&(n=r.type.replace(/_/g,"-"))),{name:e,value:t,rating:"good",delta:0,entries:[],id:`v5-${Date.now()}-${Math.floor(8999999999999*Math.random())+1e12}`,navigationType:n}},F=new WeakMap;function j(e,t){return F.get(e)||F.set(e,new t),F.get(e)}var W=class{constructor(){y(this,"t");y(this,"i",0);y(this,"o",[])}h(t){if(t.hadRecentInput)return;let r=this.o[0],n=this.o.at(-1);this.i&&r&&n&&t.startTime-n.startTime<1e3&&t.startTime-r.startTime<5e3?(this.i+=t.value,this.o.push(t)):(this.i=t.value,this.o=[t]),this.t?.(t)}},R=(e,t,r={})=>{try{if(PerformanceObserver.supportedEntryTypes.includes(e)){let n=new PerformanceObserver((i=>{Promise.resolve().then((()=>{t(i.getEntries())}))}));return n.observe({type:e,buffered:!0,...r}),n}}catch{}},Q=e=>{let t=!1;return()=>{t||(e(),t=!0)}},b=-1,pe=new Set,se=()=>document.visibilityState!=="hidden"||document.prerendering?1/0:0,X=e=>{if(document.visibilityState==="hidden"){if(e.type==="visibilitychange")for(let t of pe)t();isFinite(b)||(b=e.type==="visibilitychange"?e.timeStamp:0,removeEventListener("prerenderingchange",X,!0))}},N=()=>{if(b<0){let e=I();b=(document.prerendering?void 0:globalThis.performance.getEntriesByType("visibility-state").filter((r=>r.name==="hidden"&&r.startTime>e))[0]?.startTime)??se(),addEventListener("visibilitychange",X,!0),addEventListener("prerenderingchange",X,!0),M((()=>{setTimeout((()=>{b=se()}))}))}return{get firstHiddenTime(){return b},onHidden(e){pe.add(e)}}},_=e=>{document.prerendering?addEventListener("prerenderingchange",(()=>e()),!0):e()},ae=[1800,3e3],Z=(e,t={})=>{_((()=>{let r=N(),n,i=w("FCP"),o=R("paint",(a=>{for(let c of a)c.name==="first-contentful-paint"&&(o.disconnect(),c.startTime<r.firstHiddenTime&&(i.value=Math.max(c.startTime-I(),0),i.entries.push(c),n(!0)))}));o&&(n=h(e,i,ae,t.reportAllChanges),M((a=>{i=w("FCP"),n=h(e,i,ae,t.reportAllChanges),K((()=>{i.value=performance.now()-a.timeStamp,n(!0)}))})))}))},ce=[.1,.25],he=(e,t={})=>{let r=N();Z(Q((()=>{let n,i=w("CLS",0),o=j(t,W),a=u=>{for(let m of u)o.h(m);o.i>i.value&&(i.value=o.i,i.entries=o.o,n())},c=R("layout-shift",a);c&&(n=h(e,i,ce,t.reportAllChanges),r.onHidden((()=>{a(c.takeRecords()),n(!0)})),M((()=>{o.i=0,i=w("CLS",0),n=h(e,i,ce,t.reportAllChanges),K((()=>n()))})),setTimeout(n))})))},we=0,V=1/0,D=0,Ve=e=>{for(let t of e)t.interactionId&&(V=Math.min(V,t.interactionId),D=Math.max(D,t.interactionId),we=D?(D-V)/7+1:0)},G,de=()=>G?we:performance.interactionCount??0,We=()=>{"interactionCount"in performance||G||(G=R("event",Ve,{type:"event",buffered:!0,durationThreshold:0}))},le=0,$=class{constructor(){y(this,"u",[]);y(this,"l",new Map);y(this,"m");y(this,"p")}v(){le=de(),this.u.length=0,this.l.clear()}L(){let t=Math.min(this.u.length-1,Math.floor((de()-le)/50));return this.u[t]}h(t){if(this.m?.(t),!t.interactionId&&t.entryType!=="first-input")return;let r=this.u.at(-1),n=this.l.get(t.interactionId);if(n||this.u.length<10||t.duration>r.P){if(n?t.duration>n.P?(n.entries=[t],n.P=t.duration):t.duration===n.P&&t.startTime===n.entries[0].startTime&&n.entries.push(t):(n={id:t.interactionId,entries:[t],P:t.duration},this.l.set(n.id,n),this.u.push(n)),this.u.sort(((i,o)=>o.P-i.P)),this.u.length>10){let i=this.u.splice(10);for(let o of i)this.l.delete(o.id)}this.p?.(n)}}},ye=e=>{let t=globalThis.requestIdleCallback||setTimeout;document.visibilityState==="hidden"?e():(e=Q(e),addEventListener("visibilitychange",e,{once:!0,capture:!0}),t((()=>{e(),removeEventListener("visibilitychange",e,{capture:!0})})))},ue=[200,500],ve=(e,t={})=>{if(!globalThis.PerformanceEventTiming||!("interactionId"in PerformanceEventTiming.prototype))return;let r=N();_((()=>{We();let n,i=w("INP"),o=j(t,$),a=u=>{ye((()=>{for(let p of u)o.h(p);let m=o.L();m&&m.P!==i.value&&(i.value=m.P,i.entries=m.entries,n())}))},c=R("event",a,{durationThreshold:t.durationThreshold??40});n=h(e,i,ue,t.reportAllChanges),c&&(c.observe({type:"first-input",buffered:!0}),r.onHidden((()=>{a(c.takeRecords()),n(!0)})),M((()=>{o.v(),i=w("INP"),n=h(e,i,ue,t.reportAllChanges)})))}))},J=class{constructor(){y(this,"m")}h(t){this.m?.(t)}},me=[2500,4e3],Te=(e,t={})=>{_((()=>{let r=N(),n,i=w("LCP"),o=j(t,J),a=u=>{t.reportAllChanges||(u=u.slice(-1));for(let m of u)o.h(m),m.startTime<r.firstHiddenTime&&(i.value=Math.max(m.startTime-I(),0),i.entries=[m],n())},c=R("largest-contentful-paint",a);if(c){n=h(e,i,me,t.reportAllChanges);let u=Q((()=>{a(c.takeRecords()),c.disconnect(),n(!0)})),m=p=>{p.isTrusted&&(ye(u),removeEventListener(p.type,m,{capture:!0}))};for(let p of["keydown","click","visibilitychange"])addEventListener(p,m,{capture:!0});M((p=>{i=w("LCP"),n=h(e,i,me,t.reportAllChanges),K((()=>{i.value=performance.now()-p.timeStamp,n(!0)}))}))}}))},fe=[800,1800],z=e=>{document.prerendering?_((()=>z(e))):document.readyState!=="complete"?addEventListener("load",(()=>z(e)),!0):setTimeout(e)},be=(e,t={})=>{let r=w("TTFB"),n=h(e,r,fe,t.reportAllChanges);z((()=>{let i=Y();i&&(r.value=Math.max(i.responseStart-I(),0),r.entries=[i],n(!0),M((()=>{r=w("TTFB",0),n=h(e,r,fe,t.reportAllChanges),n(!0)})))}))};var v=null,A=0,Xe=()=>typeof crypto<"u"&&crypto.randomUUID?crypto.randomUUID():"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,e=>{let t=Math.random()*16|0;return(e==="x"?t:t&3|8).toString(16)}),Me=()=>v,k=(e,t="navigation")=>{s(()=>{v&&U("navigation"),v=Xe(),t==="initial"?A=Math.round(performance.timeOrigin):A=Date.now();let r=d({type:"pageView",action:"start",spanId:v,url:e,reason:t,timestamp:A});l(r)})},U=e=>{s(()=>{if(!v)return;let t=Date.now(),r=t-A,n=d({type:"pageView",action:"end",spanId:v,url:window.location.href,reason:e,durationMs:r,timestamp:t});l(n),v=null,A=0})},P=(e,t)=>{s(()=>{let r=d({type:"lifecycle",event:e,performanceTime:performance.now(),...t});l(r)})},ke=()=>{s(()=>{k(window.location.href,"initial"),document.readyState==="loading"?document.addEventListener("DOMContentLoaded",f(()=>{P("DOMContentLoaded")})):P("DOMContentLoaded"),document.readyState!=="complete"?window.addEventListener("load",f(()=>{P("load")})):P("load"),document.addEventListener("visibilitychange",f(()=>{P("visibilitychange",{visibilityState:document.visibilityState}),document.visibilityState==="hidden"?U("hidden"):document.visibilityState==="visible"&&!v&&k(window.location.href,"navigation")})),window.addEventListener("pagehide",f(()=>{U("unload")})),window.addEventListener("beforeunload",f(()=>{U("unload")}))})};var Ce=()=>{s(()=>{let e=f(t=>{let r=Me(),n=d({type:"webVital",metric:t,...r&&{parentSpanId:r}});l(n)});Te(e),he(e),ve(e),Z(e),be(e)})};var Ge=0,te=()=>`req_${Date.now()}_${++Ge}`,C=new Map,E=new Map,L=new Map,x=5e3,O=e=>{if(C.set(e,Date.now()),C.size>100){let t=Date.now();for(let[r,n]of C.entries())t-n>x&&C.delete(r)}},$e=(e,t)=>{let r=C.get(e);if(r===void 0)return!1;let n=performance.timeOrigin+t;return Math.abs(n-r)<x?(C.delete(e),!0):!1},Je=e=>{if(E.set(e,Date.now()),E.size>100){let t=Date.now();for(let[r,n]of E.entries())t-n>x&&E.delete(r)}},Ee=e=>{let t=E.get(e);return t===void 0?!1:Date.now()-t<x?!0:(E.delete(e),!1)},Le=(e,t,r)=>{if(L.set(e,{timestamp:Date.now(),resourceType:t,tagName:r}),L.size>100){let n=Date.now();for(let[i,o]of L.entries())n-o.timestamp>x&&L.delete(i)}},ze=e=>{let t=L.get(e);return t&&Date.now()-t.timestamp<x?(L.delete(e),{failed:!0,resourceType:t.resourceType,tagName:t.tagName}):{failed:!1}},ee=e=>s(()=>typeof performance>"u"||!performance.getEntriesByType?void 0:performance.getEntriesByType("resource").filter(n=>n.name===e).pop()),Ke=()=>{s(()=>{let e=window.fetch;e&&(window.fetch=async(t,r)=>{let n=te(),i=performance.now(),{url:o,method:a}=s(()=>{let c,u;return t instanceof Request?(c=t.url,u=t.method):(c=t.toString(),u=r?.method??"GET"),{url:c,method:u}})??{url:"",method:"GET"};try{let c=await e.call(window,t,r);return s(()=>{let u=performance.now();O(o);let m=d({type:"networkRequest",requestId:n,method:a.toUpperCase(),url:o,statusCode:c.status,durationMs:Math.round(u-i),success:c.ok,requestType:"fetch",timing:ee(o)});l(m)}),c}catch(c){throw s(()=>{let u=performance.now();O(o);let m=d({type:"networkRequest",requestId:n,method:a.toUpperCase(),url:o,statusCode:0,durationMs:Math.round(u-i),success:!1,error:c instanceof Error?c.message:String(c),requestType:"fetch",timing:ee(o)});l(m)}),c}})})},Ye=()=>{s(()=>{let e=XMLHttpRequest.prototype.open,t=XMLHttpRequest.prototype.send;XMLHttpRequest.prototype.open=function(r,n,i=!0,o,a){s(()=>{this._bitdrift={method:r.toUpperCase(),url:n.toString(),requestId:te()}}),e.call(this,r,n,i,o,a)},XMLHttpRequest.prototype.send=function(r){let n=this,i=n._bitdrift;if(!i){t.call(this,r);return}let o=performance.now(),a=f(()=>{let u=performance.now();O(i.url);let m=d({type:"networkRequest",requestId:i.requestId,method:i.method,url:i.url,statusCode:n.status,durationMs:Math.round(u-o),success:n.status>=200&&n.status<400,requestType:"xmlhttprequest",timing:ee(i.url)});l(m)}),c=f(()=>{let u=performance.now();O(i.url);let m=d({type:"networkRequest",requestId:i.requestId,method:i.method,url:i.url,statusCode:0,durationMs:Math.round(u-o),success:!1,error:"Network error",requestType:"xmlhttprequest"});l(m)});n.addEventListener("load",a),n.addEventListener("error",c),n.addEventListener("abort",c),n.addEventListener("timeout",c),t.call(this,r)}})},je=()=>{if(!(typeof PerformanceObserver>"u"))try{new PerformanceObserver(f(t=>{let r=t.getEntries();queueMicrotask(f(()=>{for(let n of r)s(()=>{if($e(n.name,n.responseEnd)||n.name.startsWith("data:")||n.name.startsWith("blob:"))return;let i=Math.round(n.responseEnd-n.startTime),o=n.responseStatus??0,a=o===0?ze(n.name):{failed:!1},c=o>0?o>=200&&o<400:!a.failed,u=d({type:"networkRequest",requestId:te(),method:"GET",url:n.name,statusCode:o,durationMs:i,success:c,requestType:n.initiatorType,timing:n});Je(n.name),l(u)})}))})).observe({type:"resource",buffered:!1})}catch{}},xe=()=>{Ke(),Ye(),je()};var T="",Se=()=>{s(()=>{T=window.location.href;let e=history.pushState;history.pushState=function(r,n,i){e.call(this,r,n,i),s(()=>{let o=T,a=window.location.href;o!==a&&(T=a,ne(o,a,"pushState"),k(a,"navigation"))})};let t=history.replaceState;history.replaceState=function(r,n,i){t.call(this,r,n,i),s(()=>{let o=T,a=window.location.href;o!==a&&(T=a,ne(o,a,"replaceState"),k(a,"navigation"))})},window.addEventListener("popstate",f(()=>{let r=T,n=window.location.href;r!==n&&(T=n,ne(r,n,"popstate"),k(n,"navigation"))}))})},ne=(e,t,r)=>{let n=d({type:"navigation",fromUrl:e,toUrl:t,method:r});l(n)};var Ie=()=>{if(!(typeof PerformanceObserver>"u"))try{new PerformanceObserver(f(t=>{for(let r of t.getEntries())s(()=>{let i=r.attribution?.[0],o=d({type:"longTask",durationMs:r.duration,startTime:r.startTime,attribution:i});l(o)})})).observe({type:"longtask",buffered:!0})}catch{}};var Qe=500,Re=()=>{s(()=>{window.addEventListener("error",f(e=>{if(e instanceof ErrorEvent)return;let t=e.target;if(!t)return;let r=t.tagName?.toLowerCase();if(!r||!["img","script","link","video","audio","source","iframe"].includes(r))return;let i=t.src||t.href||"";if(!i)return;let o=Ze(r,t);Le(i,o,r),setTimeout(f(()=>{if(Ee(i))return;let a=d({type:"resourceError",resourceType:o,url:i,tagName:r});l(a)}),Qe)}),!0)})},Ze=(e,t)=>{switch(e){case"img":return"image";case"script":return"script";case"link":{let r=t.rel;return r==="stylesheet"?"stylesheet":r==="icon"||r==="shortcut icon"?"icon":"link"}case"video":return"video";case"audio":return"audio";case"source":return"media-source";case"iframe":return"iframe";default:return e}};var et=["log","warn","error","info","debug"],Ae=()=>{s(()=>{for(let e of et)B.console[e]=B.console[e]??console[e],console[e]=(...t)=>{s(()=>B.console[e]?.apply(console,t)),s(()=>{if(oe(t[0]))return;let r=Pe(t[0]),n=t.length>1?t.slice(1).map(Pe).filter(Boolean):void 0,i=d({type:"console",level:e,message:r,args:n});l(i)})}})},Pe=e=>{if(e===null)return"null";if(e===void 0)return"undefined";if(typeof e=="string")return e;if(typeof e=="number"||typeof e=="boolean")return String(e);if(e instanceof Error)return`${e.name}: ${e.message}`;try{return JSON.stringify(e,null,0)}catch{return String(e)}};var tt=new Set(["a","button","input","select","textarea","label","summary"]),nt=3,Be=1e3,rt=100,it=500,q=[],S=null,g=null,qe=()=>{if(S!==null&&(clearTimeout(S),S=null),g){let e=g.clicks[g.clicks.length-1].timestamp-g.clicks[0].timestamp;Ne(g.element,"rageClick",!1,g.clicks.length,e),g=null,q=[]}},De=()=>{s(()=>{document.addEventListener("pointerdown",f(st),!0)})},ot=e=>s(()=>{let t=e;for(;t;){let r=t.tagName.toLowerCase();if(tt.has(r))return!0;let n=t.getAttribute("role");if(n==="button"||n==="link"||n==="menuitem"||t.hasAttribute("onclick")||t.hasAttribute("tabindex")||window.getComputedStyle(t).cursor==="pointer")return!0;t=t.parentElement}return!1})??!1,st=e=>{let t=e.target;if(!t)return;let r=ot(t),n=Date.now();if(r)Ne(t,"click",!0);else{let i={x:e.clientX,y:e.clientY,timestamp:n,element:t};q.push(i),q=q.filter(a=>n-a.timestamp<Be);let o=q.filter(a=>Math.sqrt((a.x-e.clientX)**2+(a.y-e.clientY)**2)<rt);o.length>=nt&&(g&&g.element===t?g.clicks=o:(g&&qe(),g={element:t,clicks:o}),S!==null&&clearTimeout(S),S=setTimeout(()=>{qe()},it))}},Ne=(e,t,r,n,i)=>{s(()=>{let o=e.tagName.toLowerCase(),a=e.id||void 0,c=e.className?typeof e.className=="string"?e.className:e.className.toString():void 0,u=e.hasAttribute("data-redacted"),m;if(u)m="<redacted>";else if(e.textContent){let H=e.textContent.trim().replace(/\\s+/g," ");m=H.length>50?`${H.slice(0,50)}...`:H||void 0}let p=d({type:"userInteraction",interactionType:t,tagName:o,elementId:a,className:c?.slice(0,100),textContent:m,isClickable:r,clickCount:t==="rageClick"?n:void 0,timeWindowMs:t==="rageClick"?Be:void 0,duration:t==="rageClick"?i:void 0});l(p)})};var _e=()=>{s(()=>{window.addEventListener("error",f(e=>{if(e.target&&e.target!==window)return;let t=e.error,r;t instanceof Error&&(r=t.stack);let n=d({type:"error",name:t?.name??"Error",message:e.message||"Unknown error",stack:r,filename:e.filename||void 0,lineno:e.lineno||void 0,colno:e.colno||void 0});l(n)}))})},Ue=()=>{s(()=>{window.addEventListener("unhandledrejection",f(e=>{let t="Unknown rejection reason",r;if(e.reason instanceof Error)t=e.reason.message,r=e.reason.stack;else if(typeof e.reason=="string")t=e.reason;else if(e.reason!==null&&e.reason!==void 0)try{t=JSON.stringify(e.reason)}catch{t=String(e.reason)}let n=d({type:"promiseRejection",reason:t,stack:r});l(n)}))})};var at=e=>{s(()=>{window.__bitdriftBridgeInitialized||(window.__bitdriftBridgeInitialized=!0,window.bitdrift=window.bitdrift||{},window.bitdrift.config=e,ie(),l(d({type:"bridgeReady",url:window.location.href,instrumentationConfig:window.bitdrift.config})),window.bitdrift.config?.capturePageViews&&(s(()=>ke()),l(d({type:"internalAutoInstrumentation",event:"capturePageViews"}))),window.bitdrift.config?.captureNetworkRequests&&(s(()=>xe()),l(d({type:"internalAutoInstrumentation",event:"captureNetworkRequests"}))),window.bitdrift.config?.captureNavigationEvents&&(s(()=>Se()),l(d({type:"internalAutoInstrumentation",event:"captureNavigationEvents"}))),window.bitdrift.config?.captureWebVitals&&(s(()=>Ce()),l(d({type:"internalAutoInstrumentation",event:"captureWebVitals"}))),window.bitdrift.config?.captureLongTasks&&(s(()=>Ie()),l(d({type:"internalAutoInstrumentation",event:"captureLongTasks"}))),window.bitdrift.config?.captureConsoleLogs&&(s(()=>Ae()),l(d({type:"internalAutoInstrumentation",event:"captureConsoleLogs"}))),window.bitdrift.config?.captureUserInteractions&&(s(()=>De()),l(d({type:"internalAutoInstrumentation",event:"captureUserInteractions"}))),window.bitdrift.config?.captureErrors&&(s(()=>Re()),s(()=>Ue()),s(()=>_e()),l(d({type:"internalAutoInstrumentation",event:"captureErrors"}))))})};at(
"""
    private static let scriptSuffix = """
);})();
})();

"""

    /// Generates the JavaScript bundle with the provided configuration.
    ///
    /// - parameter config: The WebView instrumentation configuration
    /// - returns: The complete JavaScript bundle with config injected
    static func getScript(config: WebViewConfiguration) -> String {
        return scriptPrefix + config.toJSON() + scriptSuffix
    }
}
